<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-01-19 Wed 02:13 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Isidore Design Notebook</title>
<meta name="author" content="Site Admin." />
<meta name="generator" content="Org Mode" />

                      <link rel="stylesheet" type="text/css" href="../global.css"/>
                      <link rel="stylesheet"
                            href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/base16/solarized-light.min.css">
                      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js" defer></script>
                      <script>var hlf=function(){Array.prototype.forEach.call(document.querySelectorAll("pre.src"),function(t){var e;e=t.getAttribute("class"),e=e.replace(/src-(w+)/,"src-$1 $1"),console.log(e),t.setAttribute("class",e),hljs.highlightBlock(t)})};addEventListener("DOMContentLoaded",hlf);</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">

                                    <div class="header header-fixed">
                                      <div class="navbar container">
                                        <div class="logo"><a href="/">Hanshen Wang</a></div>
                                        <input type="checkbox" id="navbar-toggle" >
                                        <label for="navbar-toggle"><i></i></label>
                                        <nav class="menu">
                                          <ul>
                                            <li><a href="/about">About</a></li>
                                            <li><a href="/work">Work</a></li>
                                            <li><a href="/blog/archive.html">Blog</a></li>
                                            <li><a href="/contact">Contact</a></li>
                                          </ul>
                                        </nav>
                                      </div>
                                    </div>
                                    <h1 class="title">Project Isidore Design Notebook</h1>
                                    <p class="subtitle">Divus Isidorus Hispalensis ora pro nobis</p> <br/>
                                    <p class="updated"><a href="/contact#article-history">Updated:</a> 2022-01-19 Wed 02:11</p>
</div>
<div id="content" class="content">
<div class="abstract" id="orga6bfad1">
<p>

</p>

<p>
Project Isidore is a personal website written in <a href="https://en.wikipedia.org/wiki/Lisp_(programming_language)">LISP.</a> This article
simultaneously serves as project documentation and enables literate programming
via <a href="https://orgmode.org/worg/org-contrib/babel/">org-babel.</a>
</p>

</div>
<p>
<hr/>
</p>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#Introduction">1. Introduction</a></li>
<li><a href="#Common-Lisp-Environment-Setup">2. Common Lisp Environment Setup</a>
<ul>
<li><a href="#Literate-Programming">2.1. Literate Programming</a></li>
</ul>
</li>
<li><a href="#Project-Isidore-System-Definition">3. Project Isidore System Definition</a>
<ul>
<li><a href="#Libraries-System-dependencies">3.1. Libraries &amp; System dependencies</a></li>
</ul>
</li>
<li><a href="#Org-Publish-Pipeline">4. Org Publish Pipeline</a></li>
<li><a href="#Case-Study-Profiling-and-Performance">5. Case Study: Profiling and Performance</a>
<ul>
<li><a href="#Benchmarking-Profiling">5.1. Benchmarking &amp; Profiling</a></li>
</ul>
</li>
<li><a href="#Data-Persistence">6. Data Persistence</a>
<ul>
<li><a href="#PostgreSQL">6.1. PostgreSQL</a></li>
<li><a href="#In-Memory-Datastore">6.2. In-Memory Datastore</a></li>
<li><a href="#BKNR-Datastore-vs-Rucksack-vs-Postmodern">6.3. BKNR.Datastore vs Rucksack vs Postmodern</a></li>
</ul>
</li>
<li><a href="#Development-Operations">7. Development Operations</a>
<ul>
<li><a href="#Builds-Deployment">7.1. Deploying Common Lisp on Heroku and Github Actions</a>
<ul>
<li><a href="#Heroku-Buildpack-Exposition">7.1.1. Heroku Buildpack Exposition</a>
<ul>
<li><a href="#Detect-Script">Detect Script</a></li>
<li><a href="#Compile-Script">Compile Script</a>
<ul>
<li><a href="#Make-Lisp">Make Lisp</a></li>
</ul>
</li>
<li><a href="#Release-Script">Release Script</a></li>
</ul>
</li>
<li><a href="#CD-with-Github-Actions-Roswell">7.1.2. CD with Github Actions</a></li>
</ul>
</li>
<li><a href="#Testing">7.2. Testing</a>
<ul>
<li><a href="#Notes-on-Drakma">7.2.1. Notes on Drakma</a></li>
<li><a href="#Debugging">7.2.2. Debugging</a></li>
<li><a href="#Logging">7.2.3. Logging</a></li>
<li><a href="#Generate-Code-Coverage-Report">7.2.4. Generate Code Coverage Report</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#User-Manual">8. User Manual</a>
<ul>
<li><a href="#How-do-I-find-past-versions-of-a-blog-article">8.1. How do I find past versions of a blog article?</a></li>
<li><a href="#How-do-I-unsubscribe-from-the-mailing-list">8.2. How do I unsubscribe from the mailing list?</a></li>
<li><a href="#Can-I-visit-this-website-offline">8.3. Can I visit this website offline?</a></li>
<li><a href="#I-can't-find-what-I'm-looking-for-How-is-the-documentation-organized">8.4. I can't find what I'm looking for. How is the documentation organized?</a></li>
</ul>
</li>
<li><a href="#Reference-Manual">9. Reference Manual</a>
<ul>
<li><a href="#Generate-Reference-Manual">9.1. Generate Reference Manual</a></li>
</ul>
</li>
<li><a href="#Project-History-Credits">10. Project History &amp; Credits</a></li>
</ul>
</div>
</nav>
<div id="outline-container-Introduction" class="outline-2">
<h2 id="Introduction"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-Introduction">
<p>
Welcome! This is the documentation webpage of my personal website. The canonical
source code is located at <a href="https://github.com/HanshenWang/project-isidore">GitHub - HanshenWang/project-isidore: Personal Web
Application.</a> For usage, please see the <a href="#User-Manual">user manual</a> and the navigation bar
located at the top of the website.
</p>

<ul class="org-ul">
<li><a href="#Common-Lisp-Environment-Setup">Common Lisp Environment Setup - How to get started with Lisp</a></li>
<li><a href="#Org-Publish-Pipeline">Org Publish Pipeline Section - How I Blog from Org Mode</a></li>
<li><a href="#Builds-Deployment">Heroku Deployment Section - How to Deploy Common Lisp on Heroku</a></li>
<li><a href="#Project-Isidore-System-Definition">High Level Project Overview - How to navigate the source tree</a></li>
<li><a href="#User-Manual">Project Isidore User Manual - Tutorial &amp; Guides</a></li>
<li><a href="#Reference-Manual">Project Isidore Reference Manual - For Developers</a></li>
</ul>

<p>
Navigation buttons are inserted next to each header to take one back to the
table of contents.
</p>

<p>
Copyright (c) 2021 Hanshen Wang. Source code is under the <a href="https://www.gnu.org/licenses/agpl-3.0-standalone.html">GNU-AGPL-3.0 License</a>.
Blog content is available under the <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC-BY-SA 4.0 License</a> unless otherwise noted.
</p>
</div>
</div>

<div id="outline-container-Common-Lisp-Environment-Setup" class="outline-2">
<h2 id="Common-Lisp-Environment-Setup"><span class="section-number-2">2.</span> Common Lisp Environment Setup</h2>
<div class="outline-text-2" id="text-Common-Lisp-Environment-Setup">
<ul class="org-ul">
<li><a href="0d5cd091-ec8a-420d-9585-8d6ed856a00c">&lt;&#x2013;Common Lisp Config</a></li>
<li><a href="031a3b02-b36c-4875-b714-6ff8e9a3978c">&lt;&#x2013;Practical Common Lisp</a></li>
<li><a href="6588253f-4a2e-4a8c-ac23-bcb073e47213">&lt;&#x2013;Linux Program Directory</a></li>
</ul>

<blockquote>
<p>
He is like to a man building a house, who digged deep and laid the foundation
upon a rock. And when a flood came, the stream beat vehemently upon that house:
and it could not shake it: for it was founded on a rock. But he that heareth and
doth not is like to a man building his house upon the earth without a
foundation: against which the stream beat vehemently. And immediately it fell:
and the ruin of that house was great.
</p>

<p>
&#x2013;Luke 6:48-49
</p>
</blockquote>

<p>
<b>Why lisp?</b> There are always more poets than non-poets in the world, or so
I've heard.
</p>

<p>
Practically speaking, a complete and recent tour of the LISP world for beginners
has already been written: <a href="https://stevelosh.com/blog/2018/08/a-road-to-common-lisp/">Steve Losh - Intro to Common lisp</a>. Steve Losh
characterizes the field of web development &#x2013; at least in Anno Domini
2021 &#x2013; not as a hamster wheel of backwards incompatibility, but a hamster
centrifuge. A house of sand, indeed. In technical aspects, <a href="http://www.paulgraham.com/icad.html">Paul Graham's
writings</a> convey any advantages better than I can.
</p>

<p>
Below are the steps I have taken to setup a Common Lisp environment inside Spacemacs.
</p>

<ul class="org-ul">
<li>CL the Language = <a href="http://www.lispworks.com/documentation/common-lisp.html">ANSI INCITS 226-1994</a></li>
<li>CL Implementation = <a href="http://www.sbcl.org/">Steel Bank Common Lisp</a></li>
<li>CL Library/Package Manager = <a href="https://www.quicklisp.org/beta/#installation">Quicklisp</a></li>
<li>CL System Manager/Build Tooling = <a href="https://common-lisp.net/project/asdf/">Another System Definition Facility (comes bundled with SBCL)</a></li>
<li>CL IDE = <a href="https://www.spacemacs.org/">Spacemacs</a> with <a href="https://joaotavora.github.io/sly/">SLY</a></li>

<li><p>
Install Steel Bank Common Lisp, a Common Lisp implementation.
</p>

<p>
<a href="https://www.cliki.net/Common+Lisp+implementation">Other implementations of Common Lisp the language exist,</a> but SBCL is the
premier open-source implementation as of this writing.
</p>

<p>
Installing SBCL from your Linux distribution's package manager is the most
straight forward way. On Debian/Ubuntu this is as simple as
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt install sbcl
</pre>
</div>

<p>
Downloading and unpacking a binary from <a href="http://www.sbcl.org/getting.html">http://www.sbcl.org/getting.html</a> or
building from source are options for later discretion. In the shell,
</p>

<div class="org-src-container">
<pre class="src src-bash">sbcl
<span class="org-rainbow-delimiters-depth-1">(</span>+ <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>quit<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
will produce the startup SBCL banner and REPL, evaluate an expression, and quit.
</p></li>

<li><p>
Install Quicklisp - the Common Lisp Package Manager
</p>

<p>
In the shell,
</p>

<div class="org-src-container">
<pre class="src src-bash">curl -O https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp
<span class="org-comment-delimiter">## </span><span class="org-comment">Inside the SBCL prompt,</span>
<span class="org-rainbow-delimiters-depth-1">(</span>quicklisp-quickstart:install<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:add-to-init-file<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment-delimiter"># </span><span class="org-comment">autoload into sbcl initialization</span>
<span class="org-rainbow-delimiters-depth-1">(</span>quit<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
After loading &#x2013; via <code>(ql:quickload :project-name)</code> &#x2013; a project, it will be
stored locally. It will be in a directory similar to:
</p>

<div class="org-src-container">
<pre class="src src-bash">/home/$<span class="org-variable-name">USER</span>/quicklisp/dists/quicklisp/software/example-project-2020-01-01-git
</pre>
</div>

<p>
Also, <code>(ql:where-is-system 'system-name)</code> will return the system's location.
<code>project-name</code> and <code>system-name</code> are interchangeable here.
</p>

<p>
In order to <code>(ql:quickload :your-local-project)</code> Quicklisp looks in
<code>/home/$USER/quicklisp/local-projects/</code> for said project. You can symlink
your project if you desire to use some other folder.
</p>

<div class="org-src-container">
<pre class="src src-bash">ln -s /home/$<span class="org-variable-name">USER</span>/quicklisp/local-projects/project-a/ /home/$<span class="org-variable-name">USER</span>/project-a/
</pre>
</div>

<p>
Not of primary importance yet is a definitions of what entails a lisp
<code>package</code> or lisp <code>system</code>. It will explained in proper order during your
introduction to the language, to be more specific it is covered in <a href="https://gigamonkeys.com/book/programming-in-the-large-packages-and-symbols.html">Peter
Seibel's excellent pedagogical work, Practical Common Lisp</a> and other
guides are located <a href="https://github.com/fare/asdf/blob/master/doc/best_practices.md#trivial-system-definition">here</a> and <a href="https://ashok-khanna.medium.com/an-introduction-to-lisp-packages-7a9ee352006e">here.</a> N.B. that <code>(ql:quickload
   :your-local-project)</code> also calls <code>(asdf:load-system :your-local-project)</code>.
The difference is <code>(ql:quickload)</code> will download any missing system
dependencies.
</p></li>

<li><p>
Install Spacemacs <code>common-lisp</code> layer - a Common Lisp IDE
</p>

<p>
The below steps assume you are already familiar with Spacemacs. Inside
Spacemacs, <code>SPC-h-SPC RET common-lisp RET</code> and follow the layer README.
</p>

<p>
<a href="https://lispcookbook.github.io/cl-cookbook/editor-support.html">For those who are understandably wary of Emacs other IDE options exist.</a> Lisp
is one of the oldest higher level languages (beaten by FORTRAN by a few
years). With that rich tradition comes a time where the underlying hardware,
operating system, and developer tooling were unified under lisp.
Unfortunately, the closest one can reasonably come today is Emacs, a lisp
interpreter running on C/UNIX/hardware. Emacs still offers the best-in-class
experience amongst open-source offerings, but the notorious learning curve of
Emacs can be tempered with a preset configuration: Spacemacs. <a href="https://www.hanshenwang.com/blog/installation-of-spacemacs.html">For those on a
Microsoft Windows machine, I have written installation instructions.</a>
</p></li>

<li><p>
<b>Optional:</b> Enable goto definition for SBCL primitives
</p>

<p>
<a href="http://www.sbcl.org/platform-table.html">Download CL Implementation source files</a> and extract them to the location
specified by <code>(sb-ext:set-sbcl-source-location)</code>, which is set in your user
configuration dotfile: <code>/home/$USER/.sbclrc</code>. Add it if not already present,
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>sb-ext:set-sbcl-source-location <span class="org-string">"/usr/share/sbcl-source/"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now you can use <code>g d</code> to call <code>jump-to-definition</code> to
goto the raw documentation: the source code.
</p></li>

<li><p>
<b>Optional:</b> Enable offline access to the CL HyperSpec language reference
</p>

<p>
The full text of the ANSI Common Lisp Standard (1994) <a href="http://www.lispworks.com/documentation/common-lisp.html">is available online in
HTML form.</a> To have the reference handy offline and to be able to browse it
within Emacs, first download and extract <a href="https://archive.org/details/common-lisp-hyperspec">the HTML source for HyperSpec
7.0.tar.gz from the great Internet Archive.</a>
</p>

<p>
Then we can configure Emacs to open only HyperSpec links inside the Emacs web
browser <a href="https://www.gnu.org/software/emacs/manual/html_mono/eww.html">EWW</a> and also inform our Common Lisp IDE of the HyperSpec location.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setf</span> common-lisp-hyperspec-root <span class="org-string">"file:///home/$USER/HyperSpec/"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Optionally, execute the HYPERSPEC-LOOKUP function with local variable</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">changes to view HyperSpec links exclusively in EWW.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'hyperspec-lookup
            <span class="org-builtin">:around</span>
            <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-3">(</span>orig-fun <span class="org-type">&amp;rest</span> args<span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">setq-local</span> browse-url-browser-function 'eww-browse-url<span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-rainbow-delimiters-depth-3">(</span>apply orig-fun args<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now <code>, h H</code> will call <code>sly-hyperspec-lookup</code> to peruse the symbol at point
with the HyperSpec. Note the default behavior of <code>sly-hyperspec-lookup</code> is to
open a web browser at the online HyperSpec.
</p></li>
</ul>

<p>
Newcomers to the language are advised to dive right into the <a href="https://stevelosh.com/blog/2018/08/a-road-to-common-lisp/#s13-a-gentle-introduction">recommended
reading.</a> Now's a good chance to use org-babel for some note-taking. If you've
forked the repo to play around with, <a href="#Project-Isidore-System-Definition">a high-level overview of the project</a> may be
useful.
</p>
</div>

<div id="outline-container-Literate-Programming" class="outline-3">
<h3 id="Literate-Programming"><span class="section-number-3">2.1.</span> Literate Programming</h3>
<div class="outline-text-3" id="text-Literate-Programming">
<p>
Lisp was the language for research into artificial intelligence before the AI
winter. Now the field calls itself machine intelligence. The aim remains much
like the story of Icarus: to ape the most noble aspect of man, his rational
nature. Until that is realized, humans will be first and foremost the most
important audience for any computer language or software. Here is how I setup
literate programming with lisp.
</p>

<p>
You likely heard of <code>org-babel</code>, an extension of org-mode that allows one to
interleave text and code. It is comparable to a more powerful jupyter
notebook. Get lisp in org-babel blocks by, adding to your init.el/user-config.el
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>org-babel-do-load-languages
 'org-babel-load-languages
 '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>lisp . t<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
When evaluating a code block with <code>C-c C-c</code> (<code>, ,</code> in spacemacs), make sure
to start SLIME first (M-x slime RET).
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>princ <span class="org-string">"Hello World!"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Some may be familiar with <code>poly-org</code>, a MELPA package which allow multiple
major modes. Naturally this comes in handy when using literate programming.
It uses <code>font-lock-mode</code> to turn on the relevant major mode when your cursor
is inside said code block. This saves you from having to call
<code>org-edit-special</code> repeatedly.
</p>

<p>
Furthermore, for most languages you can only evaluate the
entire code block. Not so for lisp. <code>M-x slime-compile-defun</code> and <code>M-x
   slime-compile-region</code> do as they say on the tin: compile the specific
function or highlighted region at cursor. <code>Poly-org</code> breaks these functions
slightly as they do not treat <code>#+begin_src</code> and <code>#+end_src</code> as the start and
end-of-file respectively. The following emacs lisp snippet fixes that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">with-eval-after-load</span> <span class="org-string">"poly-org"</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">sly-compile-file sends entire .org file. Narrow to span as done in poly-R</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">https://github.com/polymode/poly-org/issues/25</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span>fboundp 'advice-add<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-compile-file <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-compile-defun <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-load-file <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-eval-defun <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-eval-last-expression <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>advice-add 'slime-eval-buffer <span class="org-builtin">:around</span> 'pm-execute-narrowed-to-span<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Since we've already shaved the editor yak up to this point, the last package
I'd like to mention that makes literate programming possible is
<a href="https://gitlab.com/mtekman/org-tanglesync.el">org-tanglesync</a>. To "tangle" a file is, in literate programming parlance, to
extract just the source code from a document. Then to de-tangle (two-way
sync) has always been a problem, and traditionally <code>org-babel-detangle</code> has
relied upon unsightly link comments to do so.
</p>

<p>
<code>Org-tanglesync</code> keeps your .git controlled source code and your .org mode
file in sync. And it does that without any markings or artifacts on the tangled
code, making collaboration easier. If a more elegant solution to
de-tangle a file exists out in the wild, please do let me know.
</p>
</div>
</div>
</div>

<div id="outline-container-Project-Isidore-System-Definition" class="outline-2">
<h2 id="Project-Isidore-System-Definition"><span class="section-number-2">3.</span> Project Isidore System Definition</h2>
<div class="outline-text-2" id="text-Project-Isidore-System-Definition">
<p>
Bibliographies exist for a written corpus of work. The same sort of metadata is
needed a code base. In Common Lisp, it is the <code>.asd</code> file.
</p>

<p>
Project Isidore follows the common <a href="https://wiki.c2.com/?ModelViewController">Model-view-controller (MVC) design pattern.</a>
It entails encapsulating data together with its processing (the model) and
isolate it from the manipulation (the controller) and presentation (the view)
part that has to be done on a user interface.
</p>

<p>
The project follows the <a href="https://common-lisp.net/project/asdf/asdf/The-package_002dinferred_002dsystem-extension.html">ASDF package inferred system</a> style of using <code>defpackage</code>
forms to specify file inter-dependencies. The entry point of dependency graph is
<a href="https://www.hanshenwang.com/reference/manual.html#The-project_002disidore_002fpackages-package">packages.lisp</a>. To understand the code base, the files are named after the MVC
design pattern.
</p>

<p>
For an index of symbols, functions and definitions, see the <a href="#Reference-Manual">Reference Manual</a>.
</p>
</div>
<div id="outline-container-Libraries-System-dependencies" class="outline-3">
<h3 id="Libraries-System-dependencies"><span class="section-number-3">3.1.</span> Libraries &amp; System dependencies</h3>
<div class="outline-text-3" id="text-Libraries-System-dependencies">
<ol class="org-ol">
<li><p>
Finding new Libraries &amp; Surveying the Ecosystem
</p>

<p>
Looking for a library? In addition to online search queries, use command(s)
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>ql:system-apropos <span class="org-builtin">:library</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; search for term in quicklisp dist</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:who-depends-on <span class="org-builtin">:library</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; usage in lisp ecosystem</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql-dist:dependency-tree <span class="org-builtin">:library</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; number of dependencies upstream</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">See quicklisp-stats README for example usage</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:quicklisp-stats</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; look at quicklisp download stats</span>
</pre>
</div>

<p>
In addition, look to <a href="https://github.com/sabracrolleton/sabracrolleton.github.io">Sabracrolleton's</a> detailed reviews of Common Lisp
libraries. Another great hint to library quality is the <a href="https://github.com/quicklisp">Github page for Zach
Beane,</a> who does the thankless job of maintaining Quicklisp.
</p>

<p>
Quicklisp in one respect is less like Javascript's Node Package Manager and
more like Debian's apt. Zach makes sure that ALL libraries on Quicklisp build
together. He takes this burden upon himself so the end users might avoid
<a href="https://en.wikipedia.org/wiki/Dependency_hell">dependency hell</a>.
</p>

<p>
<a href="https://gist.github.com/svetlyak40wt/03bc68c820bb3e45bc7871870379c42e">A helper to gather all lisp system's dependencies · GitHub</a>
</p>

<ul class="org-ul">
<li><a href="https://www.quicklisp.org/beta/releases.html">Quicklisp beta releases</a></li>
<li><a href="https://quickref.common-lisp.net/index-per-library.html">Quickref</a></li>
<li><a href="https://github.com/CodyReichert/awesome-cl">GitHub - CodyReichert/awesome-cl: A curated list of awesome Common Lisp frame&#x2026;</a></li>
<li><a href="https://www.cliki.net/">CLiki: the common lisp wiki</a></li>
<li><a href="https://github.com/40ants/lisp-project-of-the-day">GitHub - 40ants/lisp-project-of-the-day: Here I'll post notes about Quicklisp&#x2026;</a></li>
</ul></li>
<li><p>
Common Lisp Dependencies
</p>

<p>
Direct dependencies from ASDF:DEPENDS-ON
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Library</th>
<th scope="col" class="org-left">Author</th>
<th scope="col" class="org-left">Function</th>
<th scope="col" class="org-left">License</th>
<th scope="col" class="org-left">Runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="https://github.com/edicl/hunchentoot">Hunchentoot</a></td>
<td class="org-left">Edmund Weitz</td>
<td class="org-left">Web Server</td>
<td class="org-left">BSD-2-Clause</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/edicl/cl-who">CL-WHO</a></td>
<td class="org-left">Edmund Weitz</td>
<td class="org-left">Generate (X)HTML</td>
<td class="org-left">BSD-2-Clause</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/inaimathi/cl-css">CL-CSS</a></td>
<td class="org-left">Leo Zovic</td>
<td class="org-left">Generate CSS</td>
<td class="org-left">MIT/Expat</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://gitlab.common-lisp.net/parenscript/parenscript">Parenscript</a></td>
<td class="org-left">Manuel Odendahl</td>
<td class="org-left">CL to ES5 (JS)</td>
<td class="org-left">BSD-3-Clause</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/Shinmera/parachute">Parachute</a></td>
<td class="org-left">Nicolas Hafner</td>
<td class="org-left">Testing Framework</td>
<td class="org-left">Zlib</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/marijnh/Postmodern">Postmodern</a></td>
<td class="org-left">Marijn Haverbeke</td>
<td class="org-left">Postgres Wrapper</td>
<td class="org-left">Zlib</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/sharplispers/log4cl">Log4CL</a></td>
<td class="org-left">Max Mikhanosha</td>
<td class="org-left">Logging</td>
<td class="org-left">Apache-2.0</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/didierverna/declt">Declt</a></td>
<td class="org-left">Didier Verna</td>
<td class="org-left">Documentation</td>
<td class="org-left">ISC</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left"><a href="https://www.common-lisp.net/project/bknr/pdf/datastore-manual.pdf">BKNR.Datastore</a></td>
<td class="org-left">Hans Hubner</td>
<td class="org-left">Object Prevalence</td>
<td class="org-left">BSD-0-Clause</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/edicl/drakma">Drakma</a></td>
<td class="org-left">Edmund Weitz</td>
<td class="org-left">HTTP Client</td>
<td class="org-left">BSD-2-Clause</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left"><a href="https://github.com/deepfire/cl-org-mode">CL-Org-Mode</a></td>
<td class="org-left">Drew Crampsie</td>
<td class="org-left">Org-mode Parser</td>
<td class="org-left">Unspecified</td>
<td class="org-left">No</td>
</tr>
</tbody>
</table>

<p>
Transitive dependencies &amp; Lines of Code from running,
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">cd</span> ~/quicklisp/dists/quicklisp/software/
find . -name <span class="org-string">'*.lisp'</span> | xargs wc -l
</pre>
</div>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Date</th>
<th scope="col" class="org-left">Version (Commit)</th>
<th scope="col" class="org-right"># of Libraries</th>
<th scope="col" class="org-right">LOC</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2021-11-05</td>
<td class="org-left">v1.1.0 (7cc0598)</td>
<td class="org-right">35</td>
<td class="org-right">251532</td>
</tr>

<tr>
<td class="org-right">2021-12-23</td>
<td class="org-left">v1.2.0 (fd7c9f3)</td>
<td class="org-right">42</td>
<td class="org-right">264852</td>
</tr>
</tbody>
</table>

<p>
Cool libraries to check out:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Library</th>
<th scope="col" class="org-left">Author</th>
<th scope="col" class="org-left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CL-CSV</td>
<td class="org-left">Edward Marco Baringer</td>
<td class="org-left">Spreadsheet</td>
</tr>

<tr>
<td class="org-left">CLOG</td>
<td class="org-left">David Botton</td>
<td class="org-left">Websockets</td>
</tr>

<tr>
<td class="org-left">CL-Unification</td>
<td class="org-left">Marco Antonetti</td>
<td class="org-left">Generalized pattern matching</td>
</tr>
</tbody>
</table></li>
<li>Javascript Dependencies
<ul class="org-ul">
<li>Highlight.js 11.2.0
Upgrade via editing <code>:head</code> under <code>org-publish-project-alist</code>.</li>
<li>Mathjax 2.7.0
See <code>C-h v org-html-mathjax-options</code> and <code>org-html-mathjax-template</code>.</li>
</ul></li>
<li>Foreign Dependencies
<ul class="org-ul">
<li>PostgreSQL
See <a href="#Data-Persistence">Data Persistence</a></li>
</ul></li>
<li>Lisp Web Example Projects &amp; Misc. Resources
<ul class="org-ul">
<li><a href="https://gitlab.com/duncan-bayne/heroku-app-clozure-common-lisp">Duncan Bayne / heroku-app-clozure-common-lisp · GitLab</a>.
Used as a base template. Hence the AGPL License on my own derived work.</li>
<li><a href="https://github.com/gongzhitaao/orgcss">GitHub - gongzhitaao/orgcss: Simple and clean CSS for Org-exported HTML</a>
Used as a base template.</li>
<li><a href="https://gitlab.com/bendersteed/bread-and-roses">bendersteed / bread and roses · GitLab</a></li>
<li><a href="https://github.com/vindarel/lisp-web-template-productlist">GitHub - vindarel/lisp-web-template-productlist: A web template with Hunchent&#x2026;</a></li>
<li><a href="https://github.com/rajasegar/cl-bootstrap/tree/master/demo">cl-bootstrap/demo at master · rajasegar/cl-bootstrap · GitHub</a></li>
<li><a href="https://github.com/mtravers/wuwei/#examples">GitHub - mtravers/wuwei: WuWei &#x2013; effortless Ajax web UIs from Common Lisp</a></li>
<li><a href="https://common-lisp.net/">https://common-lisp.net/</a></li>
<li><a href="https://google.github.io/styleguide/lispguide.xml">https://google.github.io/styleguide/lispguide.xml</a></li>
<li><a href="https://github.com/cjbarber/ToolsOfTheTrade">Tools of the Trade, from Hacker News. List of SaaS services</a></li>
<li><a href="https://github.com/255kb/stack-on-a-budget">GitHub - 255kb/stack-on-a-budget: A collection of services with great free ti&#x2026;</a></li>
<li><a href="https://github.com/ripienaar/free-for-dev">GitHub - ripienaar/free-for-dev: A list of SaaS, PaaS and IaaS offerings that&#x2026;</a></li>
<li><a href="https://zaries.wordpress.com/2010/11/09/lisp-web-server-from-scratch-using-hunchentoot-and-nginx/">Lisp Web Server From Scratch using Hunchentoot and Nginx | Zaries's Blog</a></li>
<li><a href="https://github.com/rongarret/ergolib/tree/master/web">ergolib/web at master · rongarret/ergolib · GitHub</a></li>
<li><a href="https://github.com/eigenhombre/weeds">GitHub - eigenhombre/weeds: Work in progress porting my blog software to Comm&#x2026;</a></li>
<li><a href="https://github.com/mmontone/cl-forms/">GitHub - mmontone/cl-forms: Web forms handling library for Common lisp</a></li>
<li><a href="https://old.reddit.com/r/programming/comments/8gc5ef/steel_bank_common_lisp_sbcl_147_released/dybb8es/">lispm comments on Steel Bank Common Lisp (SBCL) 1.4.7 released</a></li>
</ul></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-Org-Publish-Pipeline" class="outline-2">
<h2 id="Org-Publish-Pipeline"><span class="section-number-2">4.</span> Org Publish Pipeline</h2>
<div class="outline-text-2" id="text-Org-Publish-Pipeline">
<p>
In the <code>/assets/blog/</code> folder, all <code>HTML</code> files are generated by <code>org-publish</code>.
<code>archive.html</code> lists all published articles.
</p>

<p>
In Spacemacs you will need to enable the <code>org</code> layer. Org Mode comes with Org
Publish built in. <a href="https://orgmode.org/manual/Publishing.html">Org Publish</a> takes advantage of Org's excellent export
capabilities to generate not only the HTML but also the sitemap and RSS.
</p>

<p>
To publish/update an article:
</p>
<ol class="org-ol">
<li>Prepare draft/existing notes for publishing, move .org file to input folder,
remove extraneous links, update citations, check formatting etc.</li>
<li><code>M-x RET org-publish RET blog</code></li>
<li>Commit changes in git</li>
<li><a href="#Builds-Deployment">Deploy</a></li>
</ol>

<p>
My Org Publish config is part of my literate .spacemacs org file. I plan to
publish the entire dotfile one day, similar to <a href="http://doc.norang.ca/org-mode.html">Org Mode - Organize Your Life In
Plain Text!</a> Until then, here is all the relevant configuration extracted.
</p>

<p>
Other exemplars here: <a href="https://old.reddit.com/r/emacs/comments/ng9hyq/good_tutorials_on_orgpublish/">good tutorials on org-publish : emacs</a>, <a href="https://two-wrongs.com/new-and-improved-now-powered-by-org-mode.html">New and Improved: Two-Wrongs Now Powered By Org Mode</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgc103434"><span class="org-comment-delimiter">;;</span><span class="org-comment">-------------------------------------------------------------------------</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">*** Org Ox Publish Config</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">-------------------------------------------------------------------------</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">ox-rss</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Following 2 lines are needed to exclude parent heading from table of contents but still export the content</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">https://emacs.stackexchange.com/questions/30183/orgmode-export-skip-ignore-first-headline-level</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">ox-extra</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ox-extras-activate '<span class="org-rainbow-delimiters-depth-2">(</span>ignore-headlines<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Allows exporting bibtex citations to html</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">ox-bibtex</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Exclude default CSS from html export and add external stylesheet</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> org-html-head-include-default-style nil<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Omit inline css as we use an imported stylesheet</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> org-html-htmlize-output-type 'css<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">https://www.taingram.org/blog/org-mode-blog.html</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> org-export-global-macros
      '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"timestamp"</span> . <span class="org-string">"@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">my/org-sitemap-date-entry-format</span> <span class="org-rainbow-delimiters-depth-2">(</span>entry style project<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Format ENTRY in org-publish PROJECT Sitemap format ENTRY ENTRY STYLE format that includes date."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>filename <span class="org-rainbow-delimiters-depth-5">(</span>org-publish-find-title entry project<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>= <span class="org-rainbow-delimiters-depth-5">(</span>length filename<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>format <span class="org-string">"*%s*"</span> entry<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>format <span class="org-string">"{{{timestamp(%s)}}} [[file:%s][%s]]"</span>
              <span class="org-rainbow-delimiters-depth-5">(</span>format-time-string <span class="org-string">"%Y-%m-%d"</span>
                                  <span class="org-rainbow-delimiters-depth-6">(</span>org-publish-find-date entry project<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
              entry
              filename<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> org-publish-project-alist
      '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"blog"</span>
         <span class="org-builtin">:components</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"blog-content"</span> <span class="org-string">"blog-rss"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"blog-content"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/Dropbox/project-maria/blog"</span>
         <span class="org-builtin">:html-extension</span> <span class="org-string">"html"</span>
         <span class="org-builtin">:base-extension</span> <span class="org-string">"org"</span>
         <span class="org-builtin">:recursive</span> t
         <span class="org-builtin">:publishing-function</span> org-html-publish-to-html
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"~/project-isidore/assets/blog"</span>
         <span class="org-builtin">:section-numbers</span> t
         <span class="org-builtin">:table-of-contents</span> t
         <span class="org-builtin">:exclude</span> <span class="org-string">"rss.org"</span>
         <span class="org-builtin">:with-title</span> nil
         <span class="org-builtin">:auto-sitemap</span> t
         <span class="org-builtin">:sitemap-filename</span> <span class="org-string">"archive.org"</span>
         <span class="org-builtin">:sitemap-title</span> <span class="org-string">"Blog Archive"</span>
         <span class="org-builtin">:sitemap-sort-files</span> anti-chronologically
         <span class="org-builtin">:sitemap-style</span> tree
         <span class="org-builtin">:sitemap-format-entry</span> my/org-sitemap-date-entry-format
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Use HTML5</span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">https://orgmode.org/manual/HTML-doctypes.html#HTML-doctypes</span>
         <span class="org-builtin">:html-doctype</span> <span class="org-string">"html5"</span>
         <span class="org-builtin">:html-html5-fancy</span> t
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Link to external custom stylesheet</span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">If you need code highlight from highlight.js, include the latter three lines.</span>
         <span class="org-builtin">:html-head</span> <span class="org-string">"</span>
<span class="org-string">                    &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"../global.css\"/&gt;</span>
<span class="org-string">                    &lt;link rel=\"stylesheet\"</span>
<span class="org-string">                          href=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/base16/solarized-light.min.css\"&gt;</span>
<span class="org-string">                    &lt;script src=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js\" defer&gt;&lt;/script&gt;</span>
<span class="org-string">                    &lt;script&gt;var hlf=function(){Array.prototype.forEach.call(document.querySelectorAll(\"pre.src\"),function(t){var e;e=t.getAttribute(\"class\"),e=e.replace(/src-(</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">w+)/,\"src-$1 $1\"),console.log(e),t.setAttribute(\"class\",e),hljs.highlightBlock(t)})};addEventListener(\"DOMContentLoaded\",hlf);&lt;/script&gt;"</span>
         <span class="org-builtin">:html-preamble</span> <span class="org-string">"</span>
<span class="org-string">                                  &lt;div class=\"header header-fixed\"&gt;</span>
<span class="org-string">                                    &lt;div class=\"navbar container\"&gt;</span>
<span class="org-string">                                      &lt;div class=\"logo\"&gt;&lt;a href=\"/\"&gt;Hanshen Wang&lt;/a&gt;&lt;/div&gt;</span>
<span class="org-string">                                      &lt;input type=\"checkbox\" id=\"navbar-toggle\" &gt;</span>
<span class="org-string">                                      &lt;label for=\"navbar-toggle\"&gt;&lt;i&gt;&lt;/i&gt;&lt;/label&gt;</span>
<span class="org-string">                                      &lt;nav class=\"menu\"&gt;</span>
<span class="org-string">                                        &lt;ul&gt;</span>
<span class="org-string">                                          &lt;li&gt;&lt;a href=\"/about\"&gt;About&lt;/a&gt;&lt;/li&gt;</span>
<span class="org-string">                                          &lt;li&gt;&lt;a href=\"/work\"&gt;Work&lt;/a&gt;&lt;/li&gt;</span>
<span class="org-string">                                          &lt;li&gt;&lt;a href=\"/blog/archive.html\"&gt;Blog&lt;/a&gt;&lt;/li&gt;</span>
<span class="org-string">                                          &lt;li&gt;&lt;a href=\"/contact\"&gt;Contact&lt;/a&gt;&lt;/li&gt;</span>
<span class="org-string">                                        &lt;/ul&gt;</span>
<span class="org-string">                                      &lt;/nav&gt;</span>
<span class="org-string">                                    &lt;/div&gt;</span>
<span class="org-string">                                  &lt;/div&gt;</span>
<span class="org-string">                                  &lt;h1 class=\"title\"&gt;%t&lt;/h1&gt;</span>
<span class="org-string">                                  &lt;p class=\"subtitle\"&gt;%s&lt;/p&gt; &lt;br/&gt;</span>
<span class="org-string">                                  &lt;p class=\"updated\"&gt;&lt;a href=\"/contact#article-history\"&gt;Updated:&lt;/a&gt; %C&lt;/p&gt;"</span>

         <span class="org-comment-delimiter">;; </span><span class="org-comment">Article Postamble includes</span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Javascript snippet to insert anchor links to Table of Contents</span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">HTML Footer</span>
         <span class="org-builtin">:html-postamble</span> <span class="org-string">"&lt;script&gt;</span>
<span class="org-string">                            const headers = Array.from( document.querySelectorAll('h2, h3, h4, h5, h6') );</span>

<span class="org-string">                            headers.forEach( header =&gt; {</span>
<span class="org-string">                              header.insertAdjacentHTML('afterbegin',</span>
<span class="org-string">                               '&lt;a href=\"#table-of-contents\"&gt;&amp;#8689;&lt;/a&gt;'</span>
<span class="org-string">                              );</span>
<span class="org-string">                            });</span>
<span class="org-string">                            &lt;/script&gt;</span>
<span class="org-string">                            &lt;hr/&gt;</span>
<span class="org-string">                            &lt;footer&gt;</span>
<span class="org-string">                              &lt;div class=\"copyright-container\"&gt;</span>
<span class="org-string">                                &lt;div class=\"copyright\"&gt;</span>
<span class="org-string">                                  Comments? Corrections? &lt;a</span>
<span class="org-string">                              href=\"https://hanshenwang.com/contact\"&gt;</span>
<span class="org-string">                              Please do reach out.&lt;/a&gt;&lt;a</span>
<span class="org-string">                              href=\"https://hanshenwang.com/blog/rss.xml\"&gt;</span>
<span class="org-string">                              RSS Feed. &lt;/a&gt;&lt;a</span>
<span class="org-string">                              href=\"https://hanshenwang.com/subscribe\"&gt;</span>
<span class="org-string">                              Mailing List. &lt;/a&gt;&lt;br/&gt;</span>
<span class="org-string">                                  Copyright &amp;copy; 2021 Hanshen Wang. Some Rights Reserved.&lt;br/&gt;</span>
<span class="org-string">                                  Blog content is available under</span>
<span class="org-string">                                  &lt;a rel=\"license\" href=\"http://creativecommons.org/licenses/by-sa/4.0/\"&gt;</span>
<span class="org-string">                                    CC-BY-SA 4.0</span>
<span class="org-string">                                  &lt;/a&gt; unless otherwise noted.</span>
<span class="org-string">                                &lt;/div&gt;</span>
<span class="org-string">                                &lt;div class=\"cc-badge\"&gt;</span>
<span class="org-string">                                  &lt;a rel=\"license\" href=\"http://creativecommons.org/licenses/by-sa/4.0/\"&gt;</span>
<span class="org-string">                                    &lt;img alt=\"Creative Commons License\"</span>
<span class="org-string">                                         src=\"https://i.creativecommons.org/l/by-sa/4.0/88x31.png\"</span>
<span class="org-string">                                         height=\"31\"</span>
<span class="org-string">                                         width=\"88\"&gt;</span>
<span class="org-string">                                  &lt;/a&gt;</span>
<span class="org-string">                                &lt;/div&gt;</span>
<span class="org-string">                                &lt;div class=\"rss-badge\"&gt;</span>
<span class="org-string">                                  &lt;a rel=\"license\" href=\"http://hanshenwang.com/blog/rss.xml\"&gt;</span>
<span class="org-string">                                    &lt;img alt=\"Really Simple Syndication - RSS\"</span>
<span class="org-string">                                         src=\"https://upload.wikimedia.org/wikipedia/en/thumb/4/43/Feed-icon.svg/50px-Feed-icon.svg.png\"</span>
<span class="org-string">                                         height=\"50\"</span>
<span class="org-string">                                         width=\"50\"&gt;</span>
<span class="org-string">                                  &lt;/a&gt;</span>
<span class="org-string">                                &lt;/div&gt;</span>
<span class="org-string">                              &lt;/div&gt;</span>

<span class="org-string">                              &lt;div class=\"generated\"&gt;</span>
<span class="org-string">                                Created with %c on &lt;a href=\"https://www.gnu.org\"&gt;GNU&lt;/a&gt;/&lt;a href=\"https://www.kernel.org/\"&gt;Linux&lt;/a&gt;</span>
<span class="org-string">                              &lt;/div&gt;</span>
<span class="org-string">                            &lt;/footer&gt;"</span>
         <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"blog-rss"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/Dropbox/project-maria/blog"</span>
         <span class="org-builtin">:base-extension</span> <span class="org-string">"org"</span>
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"~/project-isidore/assets/blog"</span>
         <span class="org-builtin">:publishing-function</span> publish-posts-rss-feed
         <span class="org-builtin">:rss-extension</span> <span class="org-string">"xml"</span>
         <span class="org-builtin">:html-link-home</span> <span class="org-string">"http://hanshenwang.com/"</span>
         <span class="org-builtin">:html-link-use-abs-url</span> t
         <span class="org-builtin">:html-link-org-files-as-html</span> t
         <span class="org-builtin">:exclude</span> <span class="org-string">"archive.org"</span>
         <span class="org-builtin">:auto-sitemap</span> t
         <span class="org-builtin">:sitemap-function</span> posts-rss-feed
         <span class="org-builtin">:sitemap-title</span> <span class="org-string">"Hanshen Wang Blog RSS"</span>
         <span class="org-builtin">:sitemap-filename</span> <span class="org-string">"rss.org"</span>
         <span class="org-builtin">:sitemap-style</span> list
         <span class="org-builtin">:sitemap-sort-files</span> anti-chronologically
         <span class="org-builtin">:sitemap-format-entry</span> format-posts-rss-feed-entry<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">https://alhassy.github.io/AlBasmala#Clickable-Headlines</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">my/ensure-headline-ids</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;rest</span> _<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Org trees without a custom ID will have</span>
<span class="org-doc">                            All non-alphanumeric characters are cleverly replaced with &#8216;-&#8217;.</span>

<span class="org-doc">                            If multiple trees end-up with the same id property, issue a</span>
<span class="org-doc">                            message and undo any property insertion thus far.</span>

<span class="org-doc">                            E.g., &#8623; We'll go on a &#8704;&#8707;&#8645; adventure</span>
<span class="org-doc">                               &#8614;  We'll-go-on-a-adventure</span>
<span class="org-doc">                            "</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>ids<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>org-map-entries
     <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-5">()</span>
       <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">org-with-point-at</span> <span class="org-rainbow-delimiters-depth-6">(</span>point<span class="org-rainbow-delimiters-depth-6">)</span>
         <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-rainbow-delimiters-depth-8">(</span>id <span class="org-rainbow-delimiters-depth-9">(</span>org-entry-get nil <span class="org-string">"CUSTOM_ID"</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span>
           <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">unless</span> id
             <span class="org-rainbow-delimiters-depth-8">(</span><span class="org-keyword">thread-last</span> <span class="org-rainbow-delimiters-depth-9">(</span>nth <span class="org-highlight-numbers-number">4</span> <span class="org-rainbow-delimiters-depth-1">(</span>org-heading-components<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>s-replace-regexp <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">[:alnum:]']"</span> <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>s-replace-regexp <span class="org-string">"-+"</span> <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>s-chop-prefix <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>s-chop-suffix <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span><span class="org-keyword">setq</span> id<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>
             <span class="org-rainbow-delimiters-depth-8">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-9">(</span>not <span class="org-rainbow-delimiters-depth-1">(</span>member id ids<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-9">)</span>
                 <span class="org-rainbow-delimiters-depth-9">(</span><span class="org-keyword">push</span> id ids<span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>message-box <span class="org-string">"Oh no, a repeated id!\n\n\t%s"</span> id<span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span>undo<span class="org-rainbow-delimiters-depth-9">)</span>
               <span class="org-rainbow-delimiters-depth-9">(</span><span class="org-keyword">setq</span> quit-flag t<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>
             <span class="org-rainbow-delimiters-depth-8">(</span>org-entry-put nil <span class="org-string">"CUSTOM_ID"</span> id<span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Whenever html &amp; md export happens, ensure we have headline ids.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-html-export-to-html   <span class="org-builtin">:before</span> 'my/ensure-headline-ids<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-md-export-to-markdown <span class="org-builtin">:before</span> 'my/ensure-headline-ids<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">https://nicolasknoebber.com/posts/blogging-with-emacs-and-org.html</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">format-posts-rss-feed-entry</span> <span class="org-rainbow-delimiters-depth-2">(</span>entry _style project<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Format ENTRY for the posts RSS feed in PROJECT."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>org-publish-initialize-cache <span class="org-string">"blog-rss"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>title <span class="org-rainbow-delimiters-depth-5">(</span>org-publish-find-title entry project<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>link <span class="org-rainbow-delimiters-depth-5">(</span>concat <span class="org-string">"blog/"</span> <span class="org-rainbow-delimiters-depth-6">(</span>file-name-sans-extension entry<span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-string">".html"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>author <span class="org-rainbow-delimiters-depth-5">(</span>org-publish-find-property entry <span class="org-builtin">:author</span> project<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>pubdate <span class="org-rainbow-delimiters-depth-5">(</span>format-time-string <span class="org-rainbow-delimiters-depth-6">(</span>car org-time-stamp-formats<span class="org-rainbow-delimiters-depth-6">)</span>
                                      <span class="org-rainbow-delimiters-depth-6">(</span>org-publish-find-date entry project<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message pubdate<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>format <span class="org-string">"%s</span>
<span class="org-string">              :properties:</span>
<span class="org-string">              :rss_permalink: %s</span>
<span class="org-string">              :author: %s</span>
<span class="org-string">              :pubdate: %s</span>
<span class="org-string">              :end:\n"</span>
            title
            link
            author
            pubdate<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">posts-rss-feed</span> <span class="org-rainbow-delimiters-depth-2">(</span>title list<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Generate a sitemap of posts that is exported as a RSS feed.</span>
<span class="org-doc">              TITLE is the title of the RSS feed.  LIST is an internal</span>
<span class="org-doc">              representation for the files to include.  PROJECT is the current</span>
<span class="org-doc">              project."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>concat
   <span class="org-string">"#+TITLE: "</span> title <span class="org-string">"\n#+EMAIL: hanshen@hanshenwang.com"</span> <span class="org-string">"\n\n"</span>
   <span class="org-rainbow-delimiters-depth-3">(</span>org-list-to-subtree list<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">publish-posts-rss-feed</span> <span class="org-rainbow-delimiters-depth-2">(</span>plist filename dir<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Publish PLIST to RSS when FILENAME is rss.org.</span>
<span class="org-doc">              DIR is the location of the output."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>equal <span class="org-string">"rss.org"</span> <span class="org-rainbow-delimiters-depth-4">(</span>file-name-nondirectory filename<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span>org-rss-publish-to-rss plist filename dir<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-Case-Study-Profiling-and-Performance" class="outline-2">
<h2 id="Case-Study-Profiling-and-Performance"><span class="section-number-2">5.</span> Case Study: Profiling and Performance</h2>
<div class="outline-text-2" id="text-Case-Study-Profiling-and-Performance">
<p>
A through treatment of the generalities of optimization in Common Lisp can be
found in weitzCommonLispRecipes2016 pages 503-560. Dr. Weitz testifies that lisp
(SBCL) can confidently reach within a 5x ballpark of C. Less, obviously, if
there are many fixnums. SBCL compiler contributor Paul Khuong has also testified
to a ballpark of 3x within C. Of course, squabbling over language performance is
time better spent on data structures and algorithms, but to have a ballpark
estimate is good to know. Python and Ruby for example, are magnitudes slower
than Lisp. Ballpark of 20x and 40x respectively. For a dynamically typed, high
level language, Lisp performs admirably. Especially striking is the non-leaky
abstraction and degree of control provided to the programmer at read, compile
and runtime; see the "disassemble" function and runtime compilation tricks.
</p>

<p>
Lastly, Professor Scott Fahlman, one of the original designers of Common Lisp,
<a href="https://www.quora.com/How-does-Commom-Lisp-compare-to-C-C-Java-and-Haskell-performance-wise-not-developer-time-Assume-Clozure-compiler-for-Common-Lisp-GCC-for-C-C-and-GHC-for-Haskell%20">weighs in on his experience circa 2020.</a>
</p>

<blockquote>
<p>
Short answer: I don’t know about the Clozure compiler, but the compiler used in
the open-source CMU Common Lisp (CMU CL) system produces code that is is very
close in performance to C a little faster for some benchmarks, a little slower
for others.
</p>

<p>
But there are some things a Common Lisp user needs to understand in order to get
that performance. Basically, you need to declare the types of variables and
arguments carefully, and you should not do a lot of dynamic storage allocation
(“consing”) in performance critical inner loops usually just 10% or 20% of your
total system.
</p>

<p>
(Steel Bank Common Lisp (SBCL) is essentially the same as CMU CL in terms of the
performance of compiled code. The CMU CL open-source community split in two in
December 1999 as a result of some disagreements about design and philosophy, and
one branch was renamed SBCL. I believe that the parts of the compiler concerned
with optimization have not changed much. I currently prefer SBCL for my work on
the Scone knowledge-base system and other things.)
</p>

<p>
The Java compilers I know about produce code that is considerably slower than
CMU CL and SBCL. I don’t know much about Haskell performance. C++ is similar to
C in performance if you use it like C; I believe that if you make heavy use of
the object-oriented features it is considerably slower.
</p>

<p>
Longer answer, for nerds: I was one of the core designers of Common Lisp. (We
were sometimes referred to in those days as the “Gang of Five”.) I wrote what I
believe was the first Common Lisp compiler (drawing heavily on the design of
earlier compilers for Maclisp and Lisp Machine Lisp).
</p>

<p>
For many years I ran the CMU Common Lisp project. As part of that project, we
developed a public-domain Common Lisp runtime that became the basis for a number
of commercial Common Lisp implementation, adapted and supported by various large
companies for their own machines.
</p>

<p>
David B. McDonald, in my group, spent something like four years developing a
very highly optimizing compiler for Common Lisp. We called this the “Python”
compiler, which caused some confusion when the Python programming language
became popular more than a decade later. No relation.
</p>

<p>
(I proposed that we name our compiler “Python” because a python the snake eats a
whole pig, then goes under a bush for several weeks to sleep. The pig makes its
way slowly through the snake’s internal pipelines, ultimately emerging as a very
compact pellet. Which is pretty much what compilers do, to one degree or
another.)
</p>

<p>
At the time the early 1980s I was starting to work on programs for implementing
(or simulating) artificial neural nets. These needed very efficient
floating-point arithmetic and vector operations, and I wanted to be sure that we
could efficiently program these things in CMU Common Lisp. But at the time,
Common Lisp had the reputation of being really awful at floating point a
straightforward implementation would constantly be allocating “boxed”
floating-point numbers that had to be garbage-collected later.
</p>

<p>
So Dave McDonald labored mightily over type inference and non-consing ways to
handle floating point, and he got the job done. I wrote some neural-net programs
in CMU CL, they were later translated into C for wider distribution (by an
undergrad coding wizard who really knew what he was doing). The two versions
were very close in runtime. When DARPA pulled the plug on support for Common
Lisp development, CMU Common Lisp became an open-source project with a different
set of developers/maintainers. Both our runtime and our “Python” compiler are
part of that distribution (and of SBCL), though of course there has been some
evolution since then.
</p>

<p>
What programmers need to know to get good performance in Common Lisp: People
speak of Lisp as a “dynamically typed” language. I think it is more correct to
call it (at least for the CMU CL implementation) an “optionally strongly typed”
language. The philosophy is this: Programmers can say as much or as little as
they like about the type of an argument or value. Whatever you say had better be
true you can tell the compiler to trust the declarations or to be suspicious.
The more precisely you specify what the entity is, the more likely it will be
that the compiler can do some clever optimization based on what you told it.
</p>

<p>
So, for example, you could say just “number” or “integer” or “integer between 0
and 1024” or “prime number between 0 and 1024”. If you use a very general
declaration, the code will work, but it will have to do some runtime
type-checking to see what kind of number it is dealing with. It must be ready to
deal with some of the exotic number-types that Common Lisp supports:
infinite-precisions integers (“bignums”), ratios of integers, imaginary numbers,
several levels of floating-point precision, and so on. There is a special, very
compact and efficient format that can be used for small integers, but it can
only be used if you tell the compiler what to expect.
</p>

<p>
The same is true of things other than integers: There are several array formats.
You can specify what size/shape data to expect, or you can wait and see what
someone hands you at runtime. When you get into object-oriented programming, you
can tell the system what to expect (and it can figure out more internal
data-types via type inference), or you can wait and see what you get and do a
runtime type-dispatch to find the proper method to use. That takes time.
</p>

<p>
So, if you want good performance in Common Lisp, especially for arithmetic and
array operations, you have to declare the types as precisely as you can. Then
the compiler will do its magic.
</p>

<p>
Flash forward: Sometime around 2001, I was working for IBM Research (on leave
for a while from CMU long story…) and my project was to implement an early
version of what became (after several restarts) my Scone knowledge-base system.
At the time, the prevalent language in IBM Research was Java, and I knew that it
would be hard to interest the IBM people in my system if I did it in Lisp. So I
started out doing it in Java.
</p>

<p>
This system had essentially no arithmetic in it, but did a lot of
pointer-chasing off into main memory, a lot of boolean operations, and had a few
very intensive inner loops where it spent all its time. Common Lisp was clearly
the right tool for this job, but I worked hard on the Java version. Finally, for
reasons too complicated to go into here, I decided that I could no longer stand
programming the system in Java some very important facilities were missing,
especially the Lisp macro system so I decided to port the half-done system to
Common Lisp. (As predicted, IBM then lost interest, and I returned to CMU.)
</p>

<p>
The performance-critical inner loops had already been programmed at that time,
so I was able to compare the performance of the Lisp and Java versions. The Lisp
version was about 3X faster. Part of that difference was because I was a very
good Lisp programmer, and rather new at Java, though I had talked to Java
experts about how to get good performance for code like mine. So some of the
performance difference was experience, but mostly it was because at the time
(and I think still today) Java did not do a lot of object-type inference at
compile time. So pretty much every function call was a type-dispatch to find the
right method, and that was slow.
</p>

<p>
There wasn’t a good way around this inefficiency except by writing the
performance-critical code as long linear stretches of code with no function
calls. And without a good macro system, that was much too tedious.
</p>
</blockquote>

<p>
What follows is an amateur recording of my struggles, useful to jog my memory in
the future when working with the SBCL statistical profiler. I had a pretty good
idea the function call that needed to be profiled, but if it was a foreign
system, I would try a library like <a href="https://gitlab.common-lisp.net/dkochmanski/metering">Daniel Kochmański / metering · GitLab</a>.
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Load project into image.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Load SBCL's statisical profiler.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> <span class="org-constant">:sb-sprof</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Includes COMMON LISP USER package symbols as defined in the Hyperspec.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>sb-sprof:profile-call-counts <span class="org-string">"CL-USER"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Profile and output both graph and flat formats.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>sb-sprof:with-profiling <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:max-samples</span> <span class="org-highlight-numbers-number">5000</span>
                          <span class="org-builtin">:report</span> <span class="org-builtin">:graph</span>
                          <span class="org-builtin">:loop</span> t
                          <span class="org-builtin">:show-progress</span> t<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>project-isidore:bible-page <span class="org-string">"1-1-1-3-3-3"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">           Self        Total        Cumul
  Nr  Count     %  Count     %  Count     %    Calls  Function
------------------------------------------------------------------------
   1   2004  40.1   2004  40.1   2004  40.1        -  EQUALP
   2    299   6.0   1054  21.1   2303  46.1        -  (SB-PCL::EMF SB-MOP:SLOT-VALUE-USING-CLASS)
   3    205   4.1    205   4.1   2508  50.2        -  (LAMBDA (SB-PCL::.ARG0.) :IN "SYS:SRC;PCL;DLISP3.LISP")
   4    193   3.9    443   8.9   2701  54.0        -  (SB-PCL::FAST-METHOD BKNR.SKIP-LIST:SL-CURSOR-<span class="custom">NEXT</span> (BKNR.SKIP-LIST:SKIP-LIST-CURSOR))
   5    190   3.8   3896  77.9   2891  57.8        -  REMOVE-IF-NOT
   6    177   3.5    212   4.2   3068  61.4        -  COPY-LIST
   7    165   3.3    165   3.3   3233  64.7        -  (LAMBDA (SB-PCL::.ARG0.) :IN "SYS:SRC;PCL;BRAID.LISP")
   8    157   3.1    157   3.1   3390  67.8        -  (LAMBDA (SB-PCL::.ARG0.) :IN "SYS:SRC;PCL;PRECOM2.LISP")
   9    143   2.9    143   2.9   3533  70.7        -  foreign function syscall
  10    141   2.8    141   2.8   3674  73.5        -  SB-KERNEL:TWO-ARG-STRING-EQUAL
  11    134   2.7    134   2.7   3808  76.2        -  (LAMBDA (CLASS SB-KERNEL:INSTANCE SB-PCL::SLOTD) :IN SB-PCL::MAKE-OPTIMIZED-STD-SLOT-VALUE-USING-CLASS-METHOD-FUNCTION)
  12    121   2.4    121   2.4   3929  78.6        -  (LAMBDA (SB-KERNEL:INSTANCE) :IN SB-PCL::GET-ACCESSOR-FROM-SVUC-METHOD-FUNCTION)
  13    110   2.2    110   2.2   4039  80.8        -  (LAMBDA (SB-PCL::.ARG0.) :IN "SYS:SRC;PCL;BRAID.LISP")
</pre>
</div>

<p>
<code>Self</code> is how much time was spent doing work directly in that function. <code>Total</code>
is how much time was spent in that function, and in the functions it called. As
this is my own code, I know that REMOVE-IF-NOT calls EQUALP in a lot of
functions. But it can also be a probable hypothesis from just this data alone.
<code>Cumul</code> is obviously the additive results of the <code>Self</code> column. I have cut it
off at 80% in light of the Pareto principle. The hypothesis can be confirmed
from looking at the graph formatted portion of the profiler output, pasted
below.
</p>

<div class="org-src-container">
<pre class="src src-text">------------------------------------------------------------------------
  3840  76.8                   PROJECT-ISIDORE/MODEL:GET-BIBLE-UID [99]
    44   0.9                   REMOVE-IF-NOT [5]
    55   1.1                   PROJECT-ISIDORE/MODEL:GET-HAYDOCK-TEXT [96]
   190   3.8   3896  77.9   REMOVE-IF-NOT [5]
     1   0.0                   (LAMBDA (PROJECT-ISIDORE/MODEL::X) :IN PROJECT-ISIDORE/MODEL::FILTER-LIST-BY-VERSE) [114]
     1   0.0                   (SB-PCL::EMF SB-MOP:SLOT-VALUE-USING-CLASS) [2]
     1   0.0                   (LAMBDA (SB-PCL::.ARG0.) :IN "SYS:SRC;PCL;DLISP3.LISP") [3]
     1   0.0                   foreign function alloc_list [29]
    43   0.9                   (LAMBDA (PROJECT-ISIDORE/MODEL::X) :IN PROJECT-ISIDORE/MODEL::FILTER-LIST-BY-CHAPTER) [30]
   140   2.8                   SB-KERNEL:TWO-ARG-STRING-EQUAL [10]
  1421  28.4                   (LAMBDA (PROJECT-ISIDORE/MODEL::X) :IN PROJECT-ISIDORE/MODEL::FILTER-LIST-BY-BOOK) [17]
  2004  40.1                   EQUALP [1]
    44   0.9                   REMOVE-IF-NOT [5]
    47   0.9                   (LAMBDA (PROJECT-ISIDORE/MODEL::X) :IN PROJECT-ISIDORE/MODEL:GET-HAYDOCK-TEXT) [38]
------------------------------------------------------------------------
</pre>
</div>

<p>
GET-BIBLE-UID is expected to take up a large portion of function calls based on
my design choices and some back of the napkin math. The profiler has confirmed
the information. Let's see if we can't optimize this particular function further.
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>time <span class="org-rainbow-delimiters-depth-2">(</span>project-isidore:bible-page <span class="org-string">"1-1-1-3-3-3"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  64.490 seconds of real time
  64.673257 seconds of total run time (64.032109 user, 0.641148 system)
  [ Run times consist of 2.276 seconds GC time, and 62.398 seconds non-GC time. ]
  100.28% CPU
  160,990,605,382 processor cycles
  16,089,927,136 bytes consed
</pre>
</div>

<p>
Replacing <code>equalp</code> with <code>eql</code> in places where appropriate in the file
<code>model.lisp</code> . For the best explanation on the different equality predicates in
Common Lisp, see <a href="https://eli.thegreenplace.net/2004/08/08/equality-in-lisp">Equality in Lisp - Eli Bendersky's website</a>.
</p>

<blockquote>
<p>
Lisp's equality operators are:
</p>

<p>
= compares only numbers, regardless of type.
</p>

<p>
eq compares symbols. Two objects are eq if they are actually the same object in memory. Don't use it for numbers and characters.
</p>

<p>
eql compares symbols similarly to eq, numbers (type sensitive) and characters (case sensitive)
</p>

<p>
equal compares more general objects. Two objects are equal if they are eql, strings of eql characters, bit vectors of the same contents, or lists of equal objects. For anything else, eq is used.
</p>

<p>
equalp is like equal, just more advanced. Comparison of numbers is type insensitive. Comparison of chars and strings is case insensitive. Lists, hashes, arrays and structures are equalp if their members are equalp. For anything else, eq is used.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  74.060 seconds of real time
  74.232869 seconds of total run time (73.519834 user, 0.713035 system)
  [ Run times consist of 2.961 seconds GC time, and 71.272 seconds non-GC time. ]
  100.23% CPU
  184,855,087,325 processor cycles
  16,089,928,160 bytes consed
</pre>
</div>

<p>
Would you look at that. Worse performance as a result of going from a more
general equality predicate to a more specific equality predicate. I'm guessing
SBCL does some fancy optimization tricks here.
</p>

<p>
From Edmund Weitz on <a href="https://comp.lang.lisp.narkive.com/ZPm0wG3j/string-equal-equalp">string-equal/equalp</a>
</p>
<blockquote>
<p>
I would assume that on most implementations STRING-EQUAL is a bit
faster (given the right optimization declarations) because it "knows"
that its arguments are strings. It's most likely a micro-optimization
that's only noticable in tight loops.
</p>

<p>
It can also be self-documenting to use STRING-EQUAL because the reader
of your code then knows that you expect both of its arguments to be
strings.
</p>
</blockquote>

<p>
Therefore switching EQUALP to STRING-EQUAL in FILTER-LIST-BY-BOOK gives me
the following speedup.
</p>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  69.390 seconds of real time
  69.608650 seconds of total run time (68.808030 user, 0.800620 system)
  [ Run times consist of 2.482 seconds GC time, and 67.127 seconds non-GC time. ]
  100.32% CPU
  173,202,179,865 processor cycles
  16,089,928,912 bytes consed
</pre>
</div>

<p>
Going back a few steps and using = instead of <code>eql</code> doesn't result in anything
significant at all.
</p>

<p>
I decided to replace the functional approach of REMOVE-IF-NOT with the LOOP DSL.
<a href="https://stackoverflow.com/questions/40789987/iterate-through-a-list-and-check-each-element-with-your-own-condition">loops - Iterate through a list and check each element with your own condition&#x2026;</a>
This surprisingly did nothing.
</p>

<p>
Instead of going through the same list three times and collecting one item at a
time, I decided to remove the nested loops and go through the same list once but
collect three items. This was more due to my unfamiliarity with loop keywords.
Good speedup results.
</p>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  14.960 seconds of real time
  15.014469 seconds of total run time (14.824816 user, 0.189653 system)
  [ Run times consist of 0.963 seconds GC time, and 14.052 seconds non-GC time. ]
  100.36% CPU
  37,334,905,433 processor cycles
  6,407,417,456 bytes consed
</pre>
</div>

<p>
Removing some list copying in the filter and get-bible-uid functions yielded:
</p>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  13.300 seconds of real time
  13.353905 seconds of total run time (13.183019 user, 0.170886 system)
  [ Run times consist of 0.731 seconds GC time, and 12.623 seconds non-GC time. ]
  100.41% CPU
  33,191,116,692 processor cycles
  6,406,945,232 bytes consed
</pre>
</div>

<p>
Proving once again that I am careless and forgetful, the following change
resulted in a 133x speedup. I believe this function was coded when
<code>bknr.datastore:store-objects-with-class</code> was the only external function I was
familiar with in <code>bknr.datastore</code> and I was ignorant of
<code>bknr.datastore:store-object-with-id</code>. Prior to the change, every single time
<code>get-haydock-text</code> was called, it would iterate through all 35817 verses of the
bible to find one instance of haydock-text. Another concrete example to read the
manual of whatever library I am using.
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">get-haydock-text</span> <span class="org-rainbow-delimiters-depth-2">(</span>bible-uid<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Returns a string if bible-uid is valid else return NIL.</span>
<span class="org-doc">The bible-uid can be found by calling `</span><span class="org-doc"><span class="org-constant">get-bible-uid</span></span><span class="org-doc">' with valid arguments."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>cpylist <span class="org-rainbow-delimiters-depth-5">(</span>remove-if-not
                  <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-7">(</span>x<span class="org-rainbow-delimiters-depth-7">)</span>
                    <span class="org-rainbow-delimiters-depth-7">(</span>and x
                         <span class="org-rainbow-delimiters-depth-8">(</span>equalp
                          bible-uid
                          <span class="org-rainbow-delimiters-depth-9">(</span>slot-value x 'bknr.datastore::id<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
                  <span class="org-rainbow-delimiters-depth-6">(</span>copy-list
                   <span class="org-rainbow-delimiters-depth-7">(</span>bknr.datastore:store-objects-with-class
                    'bible<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>slot-boundp <span class="org-rainbow-delimiters-depth-5">(</span>car cpylist<span class="org-rainbow-delimiters-depth-5">)</span> 'haydock-text<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>slot-value <span class="org-rainbow-delimiters-depth-5">(</span>car cpylist<span class="org-rainbow-delimiters-depth-5">)</span> 'haydock-text<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>format t <span class="org-string">"GET-HAYDOCK-TEXT called with invalid bible-uid ~a"</span> bible-uid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">get-haydock-text</span> <span class="org-rainbow-delimiters-depth-2">(</span>bible-uid<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Returns a string if bible-uid is valid else return NIL.</span>
<span class="org-doc">The bible-uid can be found by calling `</span><span class="org-doc"><span class="org-constant">get-bible-uid</span></span><span class="org-doc">' with valid arguments."</span>
    <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>slot-boundp <span class="org-rainbow-delimiters-depth-4">(</span>bknr.datastore:store-object-with-id bible-uid<span class="org-rainbow-delimiters-depth-4">)</span> 'haydock-text<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">(</span>slot-value <span class="org-rainbow-delimiters-depth-4">(</span>bknr.datastore:store-object-with-id bible-uid<span class="org-rainbow-delimiters-depth-4">)</span> 'haydock-text<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">(</span>format t <span class="org-string">"GET-HAYDOCK-TEXT called with invalid bible-uid ~a"</span> bible-uid<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  0.100 seconds of real time
  0.107482 seconds of total run time (0.097531 user, 0.009951 system)
  [ Run times consist of 0.007 seconds GC time, and 0.101 seconds non-GC time. ]
  107.00% CPU
  267,219,700 processor cycles
  40,850,160 bytes consed
</pre>
</div>

<p>
I admit this was less of an exercise in speeding up Common Lisp and more of
a demonstration of human frailty.
</p>

<p>
Looking through the git log for commits of type "Perf" shows further optimization
commits I have done. Current result for version 1.2.0,
</p>

<div class="org-src-container">
<pre class="src src-text">Evaluation took:
  0.020 seconds of real time
  0.021109 seconds of total run time (0.021109 user, 0.000000 system)
  105.00% CPU
  52,657,948 processor cycles
  12,583,728 bytes consed
</pre>
</div>
</div>

<div id="outline-container-Benchmarking-Profiling" class="outline-3">
<h3 id="Benchmarking-Profiling"><span class="section-number-3">5.1.</span> Benchmarking &amp; Profiling</h3>
<div class="outline-text-3" id="text-Benchmarking-Profiling">
<p>
We use loader.io to benchmark our website. 250 clients per second over a
period of 1 minute. Benchmarked with commit 124e59d.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Response Time</th>
<th scope="col" class="org-left">Milliseconds</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Average</td>
<td class="org-left">42</td>
</tr>

<tr>
<td class="org-left">Min/Max</td>
<td class="org-left">17/1038</td>
</tr>
</tbody>
</table>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Bandwidth</th>
<th scope="col" class="org-right">Megabytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Sent</td>
<td class="org-right">2.33</td>
</tr>

<tr>
<td class="org-left">Received</td>
<td class="org-right">15.47</td>
</tr>
</tbody>
</table>

<p>
In the future we can try using apache bench. A trade-off in some accuracy for
convenience.
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt install apache2-utils
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-Data-Persistence" class="outline-2">
<h2 id="Data-Persistence"><span class="section-number-2">6.</span> Data Persistence</h2>
<div class="outline-text-2" id="text-Data-Persistence">
<p>
Project Isidore's solution is split two-fold. Operations that require writes or
that would require a client-server architecture is served by the
industry-standard Relational DataBase Management System (RDBMS) PostgreSQL.
Read-only data is stored by the object prevalence model library BKNR.Datastore.
</p>
</div>

<div id="outline-container-PostgreSQL" class="outline-3">
<h3 id="PostgreSQL"><span class="section-number-3">6.1.</span> PostgreSQL</h3>
<div class="outline-text-3" id="text-PostgreSQL">
<p>
All of Lisp's homoiconic syntax aside, to create data that will persist after
the program is shut down is a useful things to do. We cannot write to a file as
<a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem">Heroku has an ephemeral filesystem.</a> This rules out Sqlite3, and forces us to a
client-server model.
</p>

<p>
<a href="https://www.postgresql.org/docs/current/tutorial.html">PostgreSQL has very clear and structured documentation.</a> Refer to the
documentation to install PostgreSQL locally on your computer. Afterwards a good
introduction to basic Create, Read, Update, Delete (CRUD) operations is here: <a href="https://web.archive.org/web/20211006233739/https://kuomarc.wordpress.com/2012/05/13/12-steps-to-build-and-deploy-common-lisp-in-the-cloud-and-comparing-rails/">12
Steps to Build and Deploy Common Lisp in the Cloud (and Comparing Rails) |&#x2026;</a>
</p>

<p>
Documentation on Postmodern is better than your average Common Lisp library.
Still to supplement the <a href="https://github.com/marijnh/Postmodern">official docs</a> are <a href="https://sites.google.com/site/sabraonthehill/postmodern-examples/postmodern-dao">examples</a> and specifically <a href="https://read-eval-print.blogspot.com/2007/08/common-lisp-postgresql-postmodern.html">examples
using the Data Access Objects.</a>
</p>

<ol class="org-ol">
<li>To start PostgreSQL server process</li>
</ol>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">Install PostgreSQL.</span>
sudo apt install postgresql
<span class="org-comment-delimiter"># </span><span class="org-comment">Start server process. PostgreSQL defaults to PORT 5432</span>
sudo service postgresql start
<span class="org-comment-delimiter"># </span><span class="org-comment">Create database "Test"</span>
createdb test
<span class="org-comment-delimiter"># </span><span class="org-comment">Delete database "Test"</span>
dropdb test
<span class="org-comment-delimiter"># </span><span class="org-comment">Login as superuser to create user for database "Test"</span>
sudo -u postgres psql
<span class="org-comment-delimiter"># </span><span class="org-comment">See defparameter `*local-db-params*' in MODEL.LISP.</span>
CREATE USER user1 WITH PASSWORD <span class="org-string">'user1'</span>;
<span class="org-comment-delimiter"># </span><span class="org-comment">Use Shell to login as host: localhost with database: test and user:user1</span>
psql -h localhost -d test -U user1
<span class="org-comment-delimiter"># </span><span class="org-comment">Once logged in,</span>
<span class="org-variable-name">test</span>=# select * from tablename;
</pre>
</div>
</div>
</div>
<div id="outline-container-In-Memory-Datastore" class="outline-3">
<h3 id="In-Memory-Datastore"><span class="section-number-3">6.2.</span> In-Memory Datastore</h3>
<div class="outline-text-3" id="text-In-Memory-Datastore">
<p>
Design constraints imposed by the current deployment platform, Heroku &amp; Github.
</p>

<ul class="org-ul">
<li>Heroku managed PostgreSQL free tier limitations = 10000 rows, 1GB disk capacity.</li>
<li>Heroku free tier dyno memory (automatic dyno shutdown at 1GB) = 512 MB.</li>
<li>Heroku free tier slug size = 500 MB.</li>
<li>Github large file limit = 100MB-2GB.</li>
</ul>

<p>
Characteristics of Bible dataset:
</p>

<ul class="org-ul">
<li>Read-only data.</li>
<li>Dataset should be available offline.</li>
<li>Non-expanding dataset.</li>
<li>Fits within Heroku free tier dyno memory (18-20MB). Online reports of 80-140mb
RAM usage by hunchentoot + ironclad.</li>
<li>Limited developer resources mean instead of programming/debugging in LISP, I
would need to master a second domain specific programming language: SQL.</li>
<li>Very cost sensitive (cut me some slack, I'm a college student).</li>
</ul>

<p>
Object Relational Mappers (ORM) are notoriously hard to get right. It is too bad
the pure LISP persistence solutions (Allegrocache) remain proprietary. For open
source solutions, I still think <code>bknr.datastore</code> is among the best for now.
Rucksack by Arthur Lemmens is also worth playing with, but due to the
restrictions of the Heroku ephemeral filesystem, the library with the best fit
for my application would be <code>bknr.datastore</code>.
</p>

<p>
Memory-Centric Data Management A Monash Information Services White Paper by Curt
</p>
<ol class="org-ol">
<li>Monash, Ph.D. May, 2006, accessible at <a href="http://www.monash.com/whitepapers.html">http://www.monash.com/whitepapers.html</a></li>
</ol>

<p>
<a href="https://medium.com/@paul_83250/object-prevalence-an-in-memory-no-database-solution-to-persistence-a1ebcd1493b0">Object Prevalence : An In-Memory, No-Database Solution to Persistence | by Pa&#x2026;</a>
</p>

<p>
<a href="https://nicklevine.org/lisp-book/contents/chac.pdf">https://nicklevine.org/lisp-book/contents/chac.pdf</a>
</p>

<p>
<a href="https://cl-pdx.com/static/persistence-lemmens.txt">https://cl-pdx.com/static/persistence-lemmens.txt</a>
</p>
</div>
</div>

<div id="outline-container-BKNR-Datastore-vs-Rucksack-vs-Postmodern" class="outline-3">
<h3 id="BKNR-Datastore-vs-Rucksack-vs-Postmodern"><span class="section-number-3">6.3.</span> BKNR.Datastore vs Rucksack vs Postmodern</h3>
<div class="outline-text-3" id="text-BKNR-Datastore-vs-Rucksack-vs-Postmodern">
<p>
<a href="https://common-lisp.net/project/rucksack/">Rucksack</a> measurements are listed first, then <a href="https://github.com/hanshuebner/bknr-datastore">BKNR.Datastore.</a>
</p>

<div class="org-src-container">
<pre class="src src-text">PROJECT-ISIDORE/VIEWS&gt; (time (get-bible-text1 24))
Evaluation took:
  0.000 seconds of real time
  0.001632 seconds of total run time (0.001632 user, 0.000000 system)
  100.00% CPU
  4,059,510 processor cycles
  2,638,816 bytes consed

;; BKNR.Datastore index starts at 0.
PROJECT-ISIDORE/VIEWS&gt; (time (get-bible-text 23))
Evaluation took:
  0.000 seconds of real time
  0.000020 seconds of total run time (0.000020 user, 0.000000 system)
  100.00% CPU
  36,872 processor cycles
  0 bytes consed

PROJECT-ISIDORE/VIEWS&gt; (time (bible-page "1-1-1-2-2-2"))
Evaluation took:
  11.260 seconds of real time
  10.095437 seconds of total run time (7.650386 user, 2.445051 system)
  [ Run times consist of 1.531 seconds GC time, and 8.565 seconds non-GC time. ]
  89.65% CPU
  28,126,150,785 processor cycles
  12,443,308,352 bytes consed

PROJECT-ISIDORE/VIEWS&gt; (time (bible-page "1-1-1-2-2-2"))
Evaluation took:
  0.440 seconds of real time
  0.441031 seconds of total run time (0.431896 user, 0.009135 system)
  [ Run times consist of 0.017 seconds GC time, and 0.425 seconds non-GC time. ]
  100.23% CPU
  1,098,042,384 processor cycles
  91,860,080 bytes consed

PROJECT-ISIDORE/VIEWS&gt; (time (bible-page "1-1-1-73-22-21"))
Evaluation took:
  252.620 seconds of real time
  225.415922 seconds of total run time (173.072441 user, 52.343481 system)
  [ Run times consist of 33.043 seconds GC time, and 192.373 seconds non-GC time. ]
  89.23% CPU
  630,541,375,724 processor cycles
  285,064,582,544 bytes consed

PROJECT-ISIDORE/VIEWS&gt; (time (bible-page "1-1-1-73-22-21"))
Evaluation took:
  0.660 seconds of real time
  0.659741 seconds of total run time (0.641298 user, 0.018443 system)
  [ Run times consist of 0.025 seconds GC time, and 0.635 seconds non-GC time. ]
  100.00% CPU
  1,641,964,703 processor cycles
  327,536,880 bytes consed
</pre>
</div>

<p>
A sampling of <a href="https://github.com/marijnh/Postmodern">postmodern</a> DAO speeds,
</p>

<div class="org-src-container">
<pre class="src src-text">PROJECT-ISIDORE/MODEL&gt; (time (friend-email (mailinglist-get 2)))
Evaluation took:
  0.010 seconds of real time
  0.002794 seconds of total run time (0.002794 user, 0.000000 system)
  30.00% CPU
  25,589,575 processor cycles
  32,432 bytes consed

"Bob234@gmail.com"
</pre>
</div>

<p>
And a regular SQL query done in postmodern,
</p>

<div class="org-src-container">
<pre class="src src-text">PROJECT-ISIDORE/MODEL&gt;  (time (pomo:with-connection (db-params) (pomo:query (:select 'email :from 'mailinglist :where (:= 'id 2)) :single)))
Evaluation took:
  0.010 seconds of real time
  0.003089 seconds of total run time (0.003089 user, 0.000000 system)
  30.00% CPU
  24,084,690 processor cycles
  16,368 bytes consed

"Bob234@gmail.com"
1 (1 bit, #x1, #o1, #b1)
</pre>
</div>

<p>
A sampling of <a href="https://common-lisp.net/project/cl-sqlite/">cl-sqlite</a> with the in-memory database,
</p>

<div class="org-src-container">
<pre class="src src-text">SQLITE&gt;
(time (execute-single *db* "select id from users where user_name = ?" "dvk"))
Evaluation took:
  0.000 seconds of real time
  0.000047 seconds of total run time (0.000045 user, 0.000002 system)
  100.00% CPU
  108,448 processor cycles
  0 bytes consed

2 (2 bits, #x2, #o2, #b10)
</pre>
</div>

<p>
and with a regular disk based database,
</p>

<div class="org-src-container">
<pre class="src src-text">SQLITE&gt; (time (execute-single *dba* "select id from users where user_name = ?" "dvk"))
Evaluation took:
  0.000 seconds of real time
  0.000085 seconds of total run time (0.000081 user, 0.000004 system)
  100.00% CPU
  196,908 processor cycles
  0 bytes consed

2 (2 bits, #x2, #o2, #b10)
</pre>
</div>

<p>
For this admittedly shallow testing, BKNR.Datastore and Rucksack perform
admirably! <a href="https://github.com/phoe/quicklisp-stats">Quicklisp-stats</a> shows BKNR.Datastore is still in use, with the most
recent example being a <a href="https://lisp-journey.gitlab.io/blog/lisp-interview-screenshotbot/">startup by an ex-Facebook engineer.</a> The most recent
mention I can find of Rucksack is by <a href="https://european-lisp-symposium.org/static/2020/lawson-slides.pdf">Ravenpack, at ELS2020.</a>
</p>

<p>
The quicklisp download stats for Rucksack show an 200% increase (from NIL &gt;
223/239) around the months of January and February. I find it plausible that
Ravenpack, who does data analysis for the financial sector, have their engineers
repull all libraries from quicklisp once per year; I have noticed same patterns
for some other libraries.
</p>

<p>
BKNR.Datastore is the reason I am able to structure the Tabular Douay Rheims in
the way that I have. Any disk based solution would have been too slow, forcing
me to cache the pages or store them as static files. Many thanks to Hans Hubner,
the author of said library. And yes, <a href="https://common-lisp.net/project/cl-store/">cl-store</a> or simple serialization would have
sufficed for my use case but I'll take Edmund Weitz's word when he recommends
BKNR.Datastore over cl-store in his ebib:weitzCommonLispRecipes2016.
</p>

<p>
The question of ORM's comes up again. As of the current writing, I am aware of a
handful of options.
</p>

<p>
<a href="https://common-lisp.net/project/elephant/">Elephant</a> - interfaces to the C databases (Berkeley DB, PostgreSQL) most likely
bitrotted, perhaps the author got hired to work on allegrocache? Quicklisp-stats
show 35 downloads total for the past 2 years.
</p>

<p>
<a href="http://clsql.kpe.io/">CLSQL</a> - by far the greatest number of backends supported, with the necessary
compromises that suggests. Tradition extends back many years, shares ideas with
<a href="http://www.lispworks.com/documentation/sql-tutorial/">CommonSQL</a> and has a SOLID track record. Packaged for Debian. Great documentation.
</p>

<p>
<a href="https://common-lisp.net/project/cl-perec/index-old.shtml">Hu.dwim.perec</a> - Originally started as a fork of CLSQL. Greatly extends the ORM
capabilities and is kept up to date: I think mostly by one person, Levente
Mészáros. This is one of the libraries that show almost exact same download
patterns as Rucksack. So what's the catch? Very little documentation. You will
have to dive deep into a bunch of hu.dwim.* packages and look at tests. Pretty
much pulls in the entire hu.dwim.* ecosystem with it when downloaded from
quicklisp. With great power comes&#x2026;
</p>

<p>
<a href="https://github.com/fukamachi/mito">Mito</a> - Fukamachi-ware. Similar download stats to CLSQL. Very young project,
started in 2016. Also see <a href="https://github.com/eudoxia0/crane/">Crane,</a> the stats show close to zero usage though.
</p>

<p>
If one is willing to make the trade-off of SQL for object persistence, then as
far as I know there are really only two pure lisp options. I say "only" but I'm
not aware of any other language with libraries comparable to the ones below.
</p>

<p>
Rucksack (open source) - as mentioned earlier, authored by hacker Arthur Lemmens
(worked at Ravenbrook). Small, written in portable lisp, possessing performance
that isn't bad at all, a real gem of a project. The mailing lists of Elephant
and Rucksack show some attempt made to combine the ideas of Rucksack into a pure
lisp backend for Elephant. Rucksack also shows a lack of recent updates, but
unlike Elephant, has users to this day. Ain't it beautiful how the stability of
the language shines through the library? Don't let the date of the last commit
turn you away. Give it a shot, look at the talk-eclm2006.txt file under the
/docs folder.
</p>

<p>
<a href="https://franz.com/products/allegrocache/">Allegrocache</a> (proprietary, Franz Inc.) - what Rucksack could have been if you
threw a bunch of money at the problem. Tightly integrated with the rest of the
Allegro CL ecosystem. You do get what you pay for in this case. I have heard
they have great support too. Allegrocache was originally based on ObjectStore
(Dan Weinreb of Symbolics fame + others). <a href="https://web.archive.org/web/20110715000000*/https://www.danweinreb.org/blog/object-oriented-database-management-systems-succeeded">Dan does a fair job at defending
object oriented database management systems here.</a> <a href="https://allegrograph.com/about-franz/">Franz Inc. has an impressive
listing of current customers.</a>
</p>
</div>
</div>
</div>

<div id="outline-container-Development-Operations" class="outline-2">
<h2 id="Development-Operations"><span class="section-number-2">7.</span> Development Operations</h2>
<div class="outline-text-2" id="text-Development-Operations">
<p>
Notes on project infrastructure.
</p>

<p>
Follow industry best practice in <a href="https://www.redhat.com/en/topics/devops/what-is-ci-cd">automating part of development operations.</a> In
the context of this project, CI/CD is taken to mean the following.
</p>

<p>
<a href="#CD-with-Github-Actions-Roswell">Continous Integration</a> = Some measure of quality assurance through unit,
integration and regression testing upon commit.
</p>

<p>
<a href="#CD-with-Github-Actions-Roswell">Continous Delivery</a> = Building an executable binary for all 3 major operating
system platforms. Binaries built this way may <a href="https://github.com/HanshenWang/project-isidore/releases">be downloaded through the Github
release interface.</a> Please note there are no developer resources at the present
to test said executables on MacOS.
</p>

<p>
<a href="#Heroku-Buildpack-Exposition">Continous Deployment</a> = Deploying executable binary on Heroku's AWS servers,
making it accessible from the World Wide Web. Heroku takes care of that for us.
Lovely.
</p>

<ol class="org-ol">
<li><p>
Current Limitations
</p>

<p>
It makes little sense to have 2 separate build processes: Github Actions and
Heroku.
</p>

<p>
Limitations of Heroku include building on "stacks" (their terminology for an OS
image) other than Ubuntu. This is becoming slowly realized through Heroku's
docker support and Cloud Native Buildpacks.
</p>

<p>
Limitations of Github Actions include a full end-to-end pipeline for deployment.
Heroku provides the expertise needed to have a application scale for the web and
a managed database to go with it. Less time spent on the infrastructure of the
software is more time developing the software itself.
</p>

<p>
Ideally in the future we can combine both Github Actions and Heroku CI into one
solution. An early prototype of the idea is <a href="https://github.com/marketplace/actions/buildpack-ci">Buildpack CI · Actions · GitHub
Marketplace · GitHub</a>
</p>

<p>
Until this technology matures, Project Isidore's build process will be
bifurcated between Github Actions for delivery onto local end-user computers and
Heroku for deployment onto <a href="https://aws.amazon.com/">AWS</a> infrastructure.
</p></li>
</ol>
</div>

<div id="outline-container-Builds-Deployment" class="outline-3">
<h3 id="Builds-Deployment"><span class="section-number-3">7.1.</span> Deploying Common Lisp on Heroku and Github Actions</h3>
<div class="outline-text-3" id="text-Builds-Deployment">
<p>
The joys of working with a compiled language means we are able to easily
distribute our program as an executable. After the binary is built, it is
deployed to Amazon severs through Heroku and made accessible through the
internet.
</p>

<p>
Github and Heroku make for an appropriate abstraction for the level we're
working at. It simplifies the process of moving development code to production code
to
</p>

<div class="org-src-container">
<pre class="src src-bash">git push origin/master
</pre>
</div>

<p>
For the uninitiated, in order to further enhance developer experience in Emacs,
an excellent git porcelain (with spacemacs layer integration) is <a href="https://magit.vc">Magit.</a> This,
paired with [<a href="#chaconProGit2014">1</a>], takes care of your version control needs.
</p>

<p>
All pushes to master branch that pass Github CI are automatically
built and deployed by Heroku. This can be setup by through the <code>deploy</code> tab
under the project menu on the Heroku website.
</p>

<ol class="org-ol">
<li><p>
Initial Setup
</p>

<p>
Make sure the project is on git version control. Install Heroku CLI. Common
Lisp is not one of Heroku's supported languages, so you will have to use the
custom buildpack in the /bin folder. Since the buildpack is short and
simplified, <a href="#Heroku-Buildpack-Exposition">I highly encourage you to roll your own.</a>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">cd</span> project-isidore
<span class="org-comment-delimiter"># </span><span class="org-comment">See the section below for an exposition of the heroku buildpack</span>
heroku create --buildpack https://github.com/HanshenWang/project-isidore
heroku config:set <span class="org-variable-name">CL_IMPL_VER</span>=<span class="org-highlight-numbers-number">2.1.9</span>
heroku config:set <span class="org-variable-name">QL_DIST_VER</span>=<span class="org-highlight-numbers-number">2020-08-07</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Push to production with</span>
git push heroku master
</pre>
</div>

<p>
You can visit your application at the provided project-name.herokuapp.com
address. To add a custom domain, see the <a href="https://devcenter.heroku.com/articles/custom-domains">Heroku documentation on custom
domain names for apps.</a> Said documentation also links to a Cloudflare document
on enabling SSL for your website.
</p>

<p>
This website can be visited at:
</p>
<ul class="org-ul">
<li>hanshenwang.com</li>
<li>project-isidore.herokuapp.com
<ul class="org-ul">
<li>Fallback URL in case I fail to renew my registration of hanshenwang.com</li>
</ul></li>
</ul>

<p>
Heroku free tier limitation means free dynos can go to sleep after a period
of inactivity . This means visitors to our application will experience
significant delay. To avoid this, two options exist. Heroku's free tier is
generous even considering vendor lock-in. Should resources be available,
upgrade to a hobby tier dyno to avoid sleeping. Alternatively, use
<a href="https://uptimerobot.com">https://uptimerobot.com</a> to ping your server every 20 minutes and to email
notifications in cases of downtime.
</p></li>
</ol>
</div>

<div id="outline-container-Heroku-Buildpack-Exposition" class="outline-4">
<h4 id="Heroku-Buildpack-Exposition"><span class="section-number-4">7.1.1.</span> Heroku Buildpack Exposition</h4>
<div class="outline-text-4" id="text-Heroku-Buildpack-Exposition">
<p>
Heroku is a platform-as-a-service. In our production server we are provided with
a clean operating system image, namely Ubuntu 20.04 LTS at the time of writing.
Because Common Lisp does not come with a pre-built buildpack from Heroku, we
will have to use their own custom build pack.
</p>

<p>
Setting up your own custom built pack is as simple as three
separate shell scripts and one make.lisp file. The <a href="https://devcenter.heroku.com/articles/buildpack-api">build pack API</a> explains
each of these shell scripts in greater depth. They are run in the following order:
</p>

<ol class="org-ol">
<li>Detect - determines if the buildpack is valid for a particular project</li>
<li>Compile - transform project from human readable source code to machine code</li>
<li>Release - start application</li>
</ol>

<p>
Why is this worth learning? Suppose you would like to use software not included
in the OS package manager. You could include the binaries in your repository,
but a <a href="https://www.petekeen.net/introduction-to-heroku-buildpacks">better solution would be adding them to your custom buildpack.</a>
</p>

<p>
The most "plug-and-play" Heroku build pack that works with the SBCL
implementation can be found here: <a href="https://gitlab.com/bendersteed/heroku-buildpack-common-lisp">bendersteed / heroku-buildpack-common-lisp ·
GitLab</a> (<a href="https://bendersteed.gitlab.io/post/deploying-common-lisp-to-heroku/">see Author's journal of the buildpack fork</a>).
</p>

<p>
My custom buildpack differs in two ways:
</p>

<ol class="org-ol">
<li>I do not use Roswell. Roswell is a useful abstraction, but is too much for my
use case. I deploy on one implementation, so having Roswell as an
implmentation manager is unneeded complexity. I believe my build process
should be as simple as needs be. Edit: In hindsight, this has proven correct.
A quick search over the project's git logs for "Roswell" will reveal past
incidents. Again, nothing but best wishes for the team behind Roswell. One
day, one day.</li>
<li>I target only SBCL. I'm not aiming to provide a general purpose buildpack for
public consumption. Still, please take what is useful from my bulidpack
located in the bin/ directory of the project repository.</li>
</ol>

<p>
The aforementioned "plug-and-play" solution is up to date and contains a
link to a sample application. If you wish to put together a buildpack suited for
your needs, I have looked through the forks of <a href="https://github.com/mtravers/heroku-buildpack-cl">Mike Travers' original Common Lisp
buildpack</a> and three stand out:
</p>

<ul class="org-ul">
<li><a href="https://github.com/avodonosov/heroku-buildpack-cl2">GitHub - avodonosov/heroku-buildpack-cl2</a>
An evolutionary variant of the original that &#x2013; and I quote from the README &#x2013;
"Doesn't force your application to be saved into a lisp image at Heroku."
Checkout the forks from this branch.</li>

<li><a href="https://github.com/hackeryarn/heroku-buildpack-cl">GitHub - hackeryarn/heroku-buildpack-cl</a> &amp; <a href="https://github.com/own-pt/heroku-buildpack-cl">GitHub - own-pt/heroku-buildpack-cl</a> are the
most direct descendants of the original. The former has a better make.lisp
(especially for Quicklisp loading) while the latter has the correct current
CURL incantation for SBCL in the compile script.</li>
</ul>
</div>
<div id="outline-container-Detect-Script" class="outline-5">
<h5 id="Detect-Script">Detect Script</h5>
<div class="outline-text-5" id="text-Detect-Script">
<div class="org-src-container">
<pre class="src src-sh" id="orgd1f8588"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> sh</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">bin/detect &lt;build-dir&gt;</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">This pack is valid for ONLY for apps with an 'project-isidore.asd' in the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">root, replace with appropriate system-definition file.</span>
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span> -f <span class="org-string">"$1/src/project-isidore.asd"</span> <span class="org-rainbow-delimiters-depth-1">]</span>; <span class="org-keyword">then</span>
  <span class="org-builtin">echo</span> <span class="org-string">"COMMON LISP"</span>
  <span class="org-keyword">exit</span> <span class="org-highlight-numbers-number">0</span>
<span class="org-keyword">else</span>
  <span class="org-builtin">echo</span> <span class="org-string">"The buildpack was unable to detect a system declaration file with the</span>
<span class="org-string">'project-isidore.asd' extension. Check if the '.slugignore' or '.gitignore' files are</span>
<span class="org-string">interfering. Make sure an '.asd' file is at the root of the directory structure.</span>

<span class="org-string">For more information, see:</span>
<span class="org-string">https://devcenter.heroku.com/articles/buildpacks</span>
<span class="org-string">https://lispcookbook.github.io/cl-cookbook/systems.html</span>
<span class="org-string">https://common-lisp.net/project/asdf/</span>
<span class="org-string">"</span>
  <span class="org-keyword">exit</span> <span class="org-highlight-numbers-number">1</span>
<span class="org-keyword">fi</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-Compile-Script" class="outline-5">
<h5 id="Compile-Script">Compile Script</h5>
<div class="outline-text-5" id="text-Compile-Script">
<p>
To call this script <code>compile</code> is a bit of a misnomer in this use case. This
script's purpose is to install a Common Lisp environment before loading <code>make.lisp</code>,
where the real magic happens.
</p>
<div class="org-src-container">
<pre class="src src-bash" id="org91668fd"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">bin/compile &lt;build-dir&gt; &lt;cache-dir&gt; &lt;env-dir&gt;</span>

<span class="org-variable-name">BUILDPACK_VERSION</span>=<span class="org-string">"1.0.48"</span>

<span class="org-comment-delimiter">#######################</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">0. Helper Functions #</span>
<span class="org-comment-delimiter">#######################</span>

<span class="org-builtin">set</span> -o errexit    <span class="org-comment-delimiter"># </span><span class="org-comment">always exit on error</span>
<span class="org-builtin">set</span> -o pipefail   <span class="org-comment-delimiter"># </span><span class="org-comment">don't ignore exit codes when piping output</span>
<span class="org-builtin">unset</span> GIT_DIR     <span class="org-comment-delimiter"># </span><span class="org-comment">Avoid GIT_DIR leak from previous build steps</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Allows us to retrieve ENV variables modified by end user</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">In Heroku CLI, see heroku:config set EXAMPLE_ENV_VAR=foobar</span>
<span class="org-keyword">function</span> <span class="org-function-name">getenv</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">ENV_NAME</span>=<span class="org-string">"$1"</span>
    <span class="org-variable-name">DEFAULT</span>=<span class="org-string">"$2"</span>
    <span class="org-variable-name">ENV_VAL</span>=<span class="org-string">"$DEFAULT"</span>

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">[</span> -f <span class="org-string">"$ENV_DIR/$ENV_NAME"</span> <span class="org-rainbow-delimiters-depth-2">]</span>; <span class="org-keyword">then</span>
        <span class="org-variable-name">ENV_VAL</span>=$<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-sh-quoted-exec">cat</span> <span class="org-string">"$ENV_DIR/$ENV_NAME"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-keyword">fi</span>

    <span class="org-builtin">echo</span> <span class="org-string">"$ENV_VAL"</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">function</span> <span class="org-function-name">log</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-builtin">echo</span> <span class="org-string">"-----&gt; $1"</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">function</span> <span class="org-function-name">info</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-builtin">echo</span> <span class="org-string">"        $1"</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">################################</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">1. Get Environment Variables #</span>
<span class="org-comment-delimiter">################################</span>

<span class="org-variable-name">BUILDPACK_DIR</span>=$<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-sh-quoted-exec">cd</span> $<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-sh-quoted-exec">dirname</span> <span class="org-string">"$0"</span><span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-builtin">cd</span> ..; <span class="org-builtin">pwd</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment-delimiter"># </span><span class="org-comment">absolute path of buildpack</span>
<span class="org-variable-name">BUILD_DIR</span>=$<span class="org-highlight-numbers-number">1</span>
<span class="org-variable-name">CACHE_DIR</span>=$<span class="org-highlight-numbers-number">2</span>
<span class="org-variable-name">ENV_DIR</span>=$<span class="org-highlight-numbers-number">3</span>
<span class="org-variable-name">CL_DIR</span>=<span class="org-string">"$CACHE_DIR/sbcl"</span>
<span class="org-variable-name">CL_IMPL</span>=<span class="org-string">"sbcl-bin"</span>
<span class="org-variable-name">CL_IMPL_VER</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">getenv</span><span class="org-string"> CL_IMPL_VER '2.2.0')"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">safe to update this manually</span>
<span class="org-variable-name">QL_DIST_VER</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">getenv</span><span class="org-string"> QL_DIST_VER '2021-12-30')"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">safe to update this manually</span>

<span class="org-comment-delimiter">####################</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">2. Run Buildpack #</span>
<span class="org-comment-delimiter">####################</span>
info <span class="org-string">"====== Common Lisp Buildpack $BUILDPACK_VERSION ======"</span>
info <span class="org-string">"BUILDPACK_DIR: $BUILDPACK_DIR"</span>
info <span class="org-string">"BUILD_DIR: $BUILD_DIR"</span>
info <span class="org-string">"CACHE_DIR: $CACHE_DIR"</span>
info <span class="org-string">"ENV_DIR: $ENV_DIR"</span>
info <span class="org-string">"CL_DIR: $CL_DIR"</span>
info <span class="org-string">"CL_IMPL: $CL_IMPL"</span>
info <span class="org-string">"CL_IMPL_VER: $CL_IMPL_VER"</span>
info <span class="org-string">"QL_DIST_VER: $QL_DIST_VER"</span>

<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span> <span class="org-string">"$RESET_CACHE"</span> <span class="org-rainbow-delimiters-depth-1">]</span>; <span class="org-keyword">then</span>
    log <span class="org-string">"Flushing Cache..."</span>
    rm -rf <span class="org-string">"${CACHEDIR:?}/"</span>*
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter">##########################################</span>
log <span class="org-string">"I. Installing STEEL BANK COMMON LISP"</span>
<span class="org-comment-delimiter">##########################################</span>

<span class="org-variable-name">CL_PACKAGE</span>=<span class="org-string">" https://sourceforge.net/projects/sbcl/files/sbcl/$CL_IMPL_VER/sbcl-$CL_IMPL_VER-x86-64-linux-binary.tar.bz2/download"</span>
<span class="org-variable-name">DECOMPRESS</span>=<span class="org-string">"tar jxf - -C $CL_DIR"</span>

rm -rf $<span class="org-variable-name">CL_DIR</span> <span class="org-comment-delimiter"># </span><span class="org-comment">delete old leftover directory</span>

<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span> <span class="org-negation-char">!</span> -d $<span class="org-variable-name">CL_DIR</span> <span class="org-rainbow-delimiters-depth-1">]</span>; <span class="org-keyword">then</span>
    info <span class="org-string">"Fetching STEEL BANK COMMON LISP..."</span>
    mkdir -p $<span class="org-variable-name">CL_DIR</span> &amp;&amp; curl -L $<span class="org-variable-name">CL_PACKAGE</span> -o - | $<span class="org-variable-name">DECOMPRESS</span>
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Add to slug</span>
cp -r $<span class="org-variable-name">CL_DIR</span> $<span class="org-variable-name">BUILD_DIR</span>
info <span class="org-string">"STEEL BANK COMMON LISP Version $CL_IMPL_VER Successfully Installed"</span>

<span class="org-comment-delimiter">##############################</span>
log <span class="org-string">"II. Installing Quicklisp"</span>
<span class="org-comment-delimiter">##############################</span>

<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span> <span class="org-negation-char">!</span> -d $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/ <span class="org-rainbow-delimiters-depth-1">]</span> ; <span class="org-keyword">then</span>
    info <span class="org-string">"Fetching Quicklisp..."</span>
    mkdir $<span class="org-variable-name">BUILDPACK_DIR</span>/lib  &amp;&amp; curl https://beta.quicklisp.org/quicklisp.lisp -o $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/quicklisp.lisp
    info <span class="org-string">"Quicklisp Successfully Installed"</span>
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter">####################################</span>
log <span class="org-string">"III. Compiling Lisp Executable"</span>
<span class="org-comment-delimiter">####################################</span>

<span class="org-builtin">export</span> BUILDPACK_DIR
<span class="org-builtin">export</span> BUILD_DIR
<span class="org-builtin">export</span> CACHE_DIR
info <span class="org-string">"Starting Build..."</span>
info <span class="org-string">"Loading $BUILDPACK_DIR/bin/make.lisp..."</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">As per /sbcl-$CL_IMPL_VER-x86-64-linux/INSTALL, we run SBCL without installing</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">it, from the top of binary distribution directory: $ sh run-sbcl.sh</span>
sh $<span class="org-variable-name">CL_DIR</span>/sbcl-$<span class="org-variable-name">CL_IMPL_VER</span>-x86-64-linux/run-sbcl.sh --dynamic-space-size <span class="org-highlight-numbers-number">2000</span> --load <span class="org-string">"$BUILDPACK_DIR/bin/make.lisp"</span>
mv -v <span class="org-string">"$BUILD_DIR/src/ProjectIsidore"</span> <span class="org-string">"$BUILD_DIR/ProjectIsidore"</span>
chmod a+x <span class="org-string">"$BUILD_DIR/ProjectIsidore"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">grant permissions for application</span>
log <span class="org-string">"Successfully Loaded $BUILDPACK_DIR/bin/make.lisp"</span>

</pre>
</div>
</div>

<div id="outline-container-Make-Lisp" class="outline-6">
<h6 id="Make-Lisp">Make Lisp</h6>
<div class="outline-text-6" id="text-Make-Lisp">
<div class="org-src-container">
<pre class="src src-lisp" id="org03a5866"><span class="org-comment-delimiter">;;;; </span><span class="org-comment">SPDX-FileCopyrightText: 2021 Hanshen Wang <a href="mailto:Hanshen%40HanshenWang.com">&lt;Hanshen@HanshenWang.com&gt;</a></span>
<span class="org-comment-delimiter">;;;; </span><span class="org-comment">SPDX-License-Identifier: AGPL-3.0-or-later</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">in-package</span> <span class="org-comment-delimiter">#:</span><span class="org-doc">cl-user</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; The buildpack requires cl-user package space.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> <span class="org-constant">:sb-posix</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; This is needed for "(uiop:getenv)".</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> <span class="org-string">"asdf"</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; The recommended way from the manual to load bundled ASDF.</span>

<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~%~&amp;        ====== MAKE.LISP ======~%"</span><span class="org-rainbow-delimiters-depth-1">)</span>
&#12;
<span class="org-comment-delimiter">;;; </span><span class="org-comment">I. ENVIRONMENT VARIABLES</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Set environment variables if they cannot be found. When running the</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">buildpack locally, i.e. with `</span><span class="org-comment"><span class="org-constant">*build-dir*</span></span><span class="org-comment">', `</span><span class="org-comment"><span class="org-constant">*buildpack-dir*</span></span><span class="org-comment">', `</span><span class="org-comment"><span class="org-constant">*cache-dir*</span></span><span class="org-comment">'</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">and `</span><span class="org-comment"><span class="org-constant">ql-dist-version</span></span><span class="org-comment">' environment variables unset, one should</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">run the shell command "sbcl --dynamic-space-size 2000 --load make.lisp"</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">while in the /bin project sub-directory.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">*buildpack-dir*</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>uiop:getenvp <span class="org-string">"BUILDPACK_DIR"</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>pathname <span class="org-rainbow-delimiters-depth-5">(</span>concatenate 'string <span class="org-rainbow-delimiters-depth-6">(</span>uiop:getenv <span class="org-string">"BUILDPACK_DIR"</span><span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">Local BUILDPACK_DIR should be equal to</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">/home/$USER/project-isidore/bin/</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>uiop:getcwd<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">*build-dir*</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>uiop:getenvp <span class="org-string">"BUILD_DIR"</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>pathname <span class="org-rainbow-delimiters-depth-5">(</span>concatenate 'string <span class="org-rainbow-delimiters-depth-6">(</span>uiop:getenv <span class="org-string">"BUILD_DIR"</span><span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">Local BUILD_DIR should be equal to</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">/home/$USER/project-isidore/</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>uiop:pathname-parent-directory-pathname <span class="org-rainbow-delimiters-depth-5">(</span>uiop:getcwd<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">*cache-dir*</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>uiop:getenvp <span class="org-string">"CACHE_DIR"</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>pathname <span class="org-rainbow-delimiters-depth-5">(</span>concatenate 'string <span class="org-rainbow-delimiters-depth-6">(</span>uiop:getenv <span class="org-string">"CACHE_DIR"</span><span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">Local CACHE_DIR should be equal to</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">/home/$USER/ as setup.lisp can usually be</span>
                            <span class="org-comment-delimiter">;; </span><span class="org-comment">found at /home/$USER/quicklisp/setup.lisp.</span>
                            <span class="org-rainbow-delimiters-depth-3">(</span>pathname-directory <span class="org-rainbow-delimiters-depth-4">(</span>uiop:pathname-parent-directory-pathname
                                                 <span class="org-rainbow-delimiters-depth-5">(</span>uiop:pathname-parent-directory-pathname
                                                  <span class="org-rainbow-delimiters-depth-6">(</span>asdf:system-source-directory <span class="org-string">"quicklisp"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Whitespace to enhance readability in Heroku logs.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        *BUILD-DIR* = ~a"</span> <span class="org-rainbow-delimiters-depth-2">(</span>make-pathname <span class="org-builtin">:directory</span> *build-dir*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        *CACHE-DIR* = ~a"</span> <span class="org-rainbow-delimiters-depth-2">(</span>make-pathname <span class="org-builtin">:directory</span> *cache-dir*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        *BUILDPACK-DIR* = ~a"</span> <span class="org-rainbow-delimiters-depth-2">(</span>make-pathname <span class="org-builtin">:directory</span> *buildpack-dir*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        COMMON-LISP-ENV = ~a:~a (Provided ASDF version ~a) on ~a~%"</span> <span class="org-rainbow-delimiters-depth-2">(</span>lisp-implementation-type<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">(</span>lisp-implementation-version<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>asdf:asdf-version<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>machine-type<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        Fixnum bits:~a~%"</span> <span class="org-rainbow-delimiters-depth-2">(</span>integer-length most-positive-fixnum<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        Features = ~a~%"</span> *features*<span class="org-rainbow-delimiters-depth-1">)</span>
&#12;
<span class="org-comment-delimiter">;;; </span><span class="org-comment">II. ASDF CONFIGURATION</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Notify ASDF of the source code location.</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Tell ASDF to store binaries in the cache dir.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>setf <span class="org-rainbow-delimiters-depth-2">(</span>uiop:getenv <span class="org-string">"XDG_CACHE_HOME"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>concatenate
                                      'string <span class="org-rainbow-delimiters-depth-3">(</span>uiop:getenv <span class="org-string">"CACHE_DIR"</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-string">"/.asdf/"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Notify ASDF that our build and cache dir is an awesome place to find '.asd'</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">files.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>asdf:initialize-source-registry `<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:source-registry</span>
                                   <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-builtin">:tree</span> ,<span class="org-rainbow-delimiters-depth-4">(</span>make-pathname <span class="org-builtin">:directory</span>
                                                          *build-dir*<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                                   <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-builtin">:tree</span> ,<span class="org-rainbow-delimiters-depth-4">(</span>make-pathname <span class="org-builtin">:directory</span>
                                                          *cache-dir*<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                                   <span class="org-builtin">:inherit-configuration</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
&#12;
<span class="org-comment-delimiter">;;; </span><span class="org-comment">III. QUICKLISP CONFIGURATION</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Because we cannot assume the existence of a ".sbclrc" initialization file,</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">we need to either load an already existent/cached setup.lisp or load the</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">downloaded quicklisp.lisp.</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">There may not be the luxury of having Quicklisp already added to the .sbclrc</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">initialization file to automatically load the quicklisp system into the lisp</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">image at startup. If `</span><span class="org-comment"><span class="org-constant">*cache-dir*</span></span><span class="org-comment">'/quicklisp exists, load SETUP.LISP.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>ql-setup <span class="org-rainbow-delimiters-depth-4">(</span>make-pathname <span class="org-builtin">:directory</span> <span class="org-rainbow-delimiters-depth-5">(</span>append *cache-dir* '<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"quicklisp"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                               <span class="org-builtin">:defaults</span> <span class="org-string">"setup.lisp"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span>ql-dist-version nil<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>probe-file ql-setup<span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span>load ql-setup<span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Otherwise install quicklisp by loading the downloaded quicklisp.lisp.</span>
      <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">progn</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>load <span class="org-rainbow-delimiters-depth-5">(</span>make-pathname <span class="org-builtin">:directory</span> <span class="org-rainbow-delimiters-depth-6">(</span>append *buildpack-dir* '<span class="org-rainbow-delimiters-depth-7">(</span><span class="org-string">"lib"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
                             <span class="org-builtin">:defaults</span> <span class="org-string">"quicklisp.lisp"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>funcall <span class="org-rainbow-delimiters-depth-5">(</span>symbol-function
                  <span class="org-rainbow-delimiters-depth-6">(</span>find-symbol <span class="org-string">"INSTALL"</span> <span class="org-rainbow-delimiters-depth-7">(</span>find-package <span class="org-string">"QUICKLISP-QUICKSTART"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-builtin">:path</span> <span class="org-rainbow-delimiters-depth-5">(</span>make-pathname <span class="org-builtin">:directory</span> <span class="org-rainbow-delimiters-depth-6">(</span>pathname-directory
                                                  ql-setup<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Install distribution as specified by `</span><span class="org-comment"><span class="org-constant">ql-dist-version</span></span><span class="org-comment">'.</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>setf ql-dist-version <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-6">(</span>uiop:getenvp <span class="org-string">"QL_DIST_VER"</span><span class="org-rainbow-delimiters-depth-6">)</span>
                                  <span class="org-rainbow-delimiters-depth-6">(</span>uiop:getenv <span class="org-string">"QL_DIST_VER"</span><span class="org-rainbow-delimiters-depth-6">)</span>
                                  <span class="org-rainbow-delimiters-depth-6">(</span>funcall <span class="org-rainbow-delimiters-depth-7">(</span>symbol-function
                                            <span class="org-rainbow-delimiters-depth-8">(</span>find-symbol <span class="org-string">"DIST-VERSION"</span> <span class="org-rainbow-delimiters-depth-9">(</span>find-package <span class="org-string">"QL-DIST"</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span>
                                           <span class="org-string">"quicklisp"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>funcall <span class="org-rainbow-delimiters-depth-5">(</span>symbol-function
                  <span class="org-rainbow-delimiters-depth-6">(</span>find-symbol <span class="org-string">"INSTALL-DIST"</span> <span class="org-rainbow-delimiters-depth-7">(</span>find-package <span class="org-string">"QL-DIST"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>format nil <span class="org-string">"http://beta.quicklisp.org/dist/quicklisp/~A/distinfo.txt"</span> ql-dist-version<span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-builtin">:replace</span> t <span class="org-builtin">:prompt</span> nil<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
&#12;
<span class="org-comment-delimiter">;;; </span><span class="org-comment">IV. TESTING</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Load Application into Lisp image.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Load separate Project Isidore test system.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:project-isidore-test</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Run Application tests.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>asdf:test-system <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span>
&#12;
<span class="org-comment-delimiter">;;; </span><span class="org-comment">V. BUILDING</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Initialize bible dataset and indexes sequentially as the search index is</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">dependent on the bible dataset being already loaded in memory.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">progn</span> <span class="org-rainbow-delimiters-depth-2">(</span>project-isidore:create-datastore<span class="org-rainbow-delimiters-depth-2">)</span>
       <span class="org-rainbow-delimiters-depth-2">(</span>format t <span class="org-string">"~&amp;        ====== Datastore loaded... Creating search index... ======~%"</span><span class="org-rainbow-delimiters-depth-2">)</span>
       <span class="org-rainbow-delimiters-depth-2">(</span>format t <span class="org-string">"~&amp;        ====== This may take a while... ======~%"</span><span class="org-rainbow-delimiters-depth-2">)</span>
       <span class="org-rainbow-delimiters-depth-2">(</span>project-isidore:create-search-index<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        ====== Build Successful | Deo Gratias ======~%"</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span>format t <span class="org-string">"~&amp;        ====== END OF MAKE.LISP ======~%"</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Dump image. For details go to src/project-isidore.asd.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>asdf:make <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">SBCL's `</span><span class="org-comment"><span class="org-constant">save-lisp-and-die</span></span><span class="org-comment">' unsurprisingly kills the lisp process at the end.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">However this behaviour is implementation dependent. This command is here in</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">case it does not kill the lisp process.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>uiop:quit<span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Release-Script" class="outline-5">
<h5 id="Release-Script">Release Script</h5>
<div class="outline-text-5" id="text-Release-Script">
<div class="org-src-container">
<pre class="src src-sh" id="org9c8d2bd"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">bin/release &lt;build-dir&gt;</span>

cat &lt;&lt; EOF
<span class="org-sh-heredoc">---</span>
<span class="org-sh-heredoc">addons:</span>
<span class="org-sh-heredoc">config_vars:</span>
<span class="org-sh-heredoc">  PATH: /usr/bin:/bin</span>
<span class="org-sh-heredoc">default_process_types:</span>
<span class="org-sh-heredoc">  web: ./ProjectIsidore</span>
<span class="org-sh-heredoc">EOF</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-CD-with-Github-Actions-Roswell" class="outline-4">
<h4 id="CD-with-Github-Actions-Roswell"><span class="section-number-4">7.1.2.</span> CD with Github Actions</h4>
<div class="outline-text-4" id="text-CD-with-Github-Actions-Roswell">
<p>
Tooling currently used includes Github Actions. Run your code on Microsoft's
servers. Hack together your devops process the UNIX way with shell
scripts/pipes and command-line utilities.
</p>

<div class="org-src-container">
<pre class="src src-bash" id="org8b85123"><span class="org-comment-delimiter">##########################################</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Continous Integration and Delivery.yml #</span>
<span class="org-comment-delimiter">##########################################</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Continous Integration and Continous Delivery are combined. This is done in the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">file ../../bin/make.lisp where the seperate system 'project-isidore-test' is</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">loaded and 'asdf:test-system' is ran prior to building the application as a</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">standalone binary. This does mean both 'project-isidore' and</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">'project-isidore-test' are loaded into the lisp image.</span>

name: CICD

<span class="org-comment-delimiter"># </span><span class="org-comment">Controls when the action will run. Triggers the workflow upon push or pull</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">request to 'master branch' OR Trigger workflow manually through</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Github Actions repo website. Upon tag starting with 'v', job named</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">'create_release' is run.</span>
on:
  push:
    branches: <span class="org-rainbow-delimiters-depth-1">[</span> master <span class="org-rainbow-delimiters-depth-1">]</span>
    tags:
      - <span class="org-string">"v*"</span>
  pull_request:
    branches: <span class="org-rainbow-delimiters-depth-1">[</span> master <span class="org-rainbow-delimiters-depth-1">]</span>
  workflow_dispatch:

<span class="org-comment-delimiter"># </span><span class="org-comment">A workflow run is made up of one or more jobs that can run sequentially or in parallel</span>
<span class="org-builtin">jobs</span>:
  build_executable_linux:
    name: GNU/Linux Build
    runs-on: <span class="org-rainbow-delimiters-depth-1">[</span>ubuntu-latest<span class="org-rainbow-delimiters-depth-1">]</span>

    steps:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Check out your repository under $GITHUB_WORKSPACE, so your job can access it</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">$GITHUB_WORKSPACE may vary under $MATRIX.OS</span>
    - name: Clone Project Isidore Repository
      uses: actions/checkout@v2

    - name: Setup GNU/Linux Environment
      run: |
        <span class="org-builtin">echo</span> <span class="org-string">"BUILDPACK_DIR=${{ github.workspace }}/bin/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"CACHE_DIR=$HOME/buildcache/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"BUILD_DIR=${{ github.workspace }}/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"QL_DIST_VER=2021-12-30"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>

    - name: Install SBCL &amp; Quicklisp
      run: |
        sudo apt install sbcl
        sudo mkdir $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/ &amp;&amp; sudo curl https://beta.quicklisp.org/quicklisp.lisp -o $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/quicklisp.lisp

    <span class="org-comment-delimiter"># </span><span class="org-comment">If Packages.lisp changes, the cache will be invalidated.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Github policy also invalidates caches not accessed in 7 days.</span>
    - name: Cache Quicklisp Libraries
      uses: actions/cache@v2
      with:
        path: $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CACHE_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>
        key: $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> runner.os <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>-build-$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> hashFiles<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">'**/packages.lisp'</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>

    - name: Build Project Isidore
      run: sbcl --dynamic-space-size <span class="org-highlight-numbers-number">2000</span> --load $<span class="org-variable-name">BUILDPACK_DIR</span>/make.lisp

    - name: Move Project Isidore Executable
      run: mv -v $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/src/ProjectIsidore $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/ProjectIsidore

    <span class="org-comment-delimiter"># </span><span class="org-comment">Github current policy is to retain logs and artifacts for 90 days.</span>
    - name: GNU/Linux Upload Lisp Build
      uses: actions/upload-artifact@v2
      with:
        name: pi-build-Linux
        path: |
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/ProjectIsidore
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/assets/
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/COPYING.txt

  build_executable_macOS:
    name: Darwin Build
    runs-on: <span class="org-rainbow-delimiters-depth-1">[</span>macos-latest<span class="org-rainbow-delimiters-depth-1">]</span>

    steps:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Check out your repository under $GITHUB_WORKSPACE, so your job can access it</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">$GITHUB_WORKSPACE may vary under $MATRIX.OS</span>
    - name: Clone Project Isidore Repository
      uses: actions/checkout@v2

    - name: Setup MacOS Environment
      run: |
        <span class="org-builtin">echo</span> <span class="org-string">"BUILDPACK_DIR=${{ github.workspace }}/bin/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"CACHE_DIR=$HOME/buildcache/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"BUILD_DIR=${{ github.workspace }}/"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>
        <span class="org-builtin">echo</span> <span class="org-string">"QL_DIST_VER=2021-12-30"</span> &gt;&gt; $<span class="org-variable-name">GITHUB_ENV</span>

    - name: Install SBCL &amp; Quicklisp
      run: |
        brew install sbcl
        sudo mkdir $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/ &amp;&amp; sudo curl https://beta.quicklisp.org/quicklisp.lisp -o $<span class="org-variable-name">BUILDPACK_DIR</span>/lib/quicklisp.lisp

    <span class="org-comment-delimiter"># </span><span class="org-comment">If Packages.lisp changes, the cache will be invalidated.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Github policy also invalidates caches not accessed in 7 days.</span>
    - name: Cache Quicklisp Libraries
      uses: actions/cache@v2
      with:
        path: $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CACHE_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>
        key: $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> runner.os <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>-build-$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> hashFiles<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">'**/packages.lisp'</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>

    - name: Build Project Isidore
      run: sbcl --dynamic-space-size <span class="org-highlight-numbers-number">2000</span> --load $<span class="org-variable-name">BUILDPACK_DIR</span>/make.lisp

    - name: Move Project Isidore Executable
      run: mv -v $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/src/ProjectIsidore $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/ProjectIsidore

    <span class="org-comment-delimiter"># </span><span class="org-comment">Github current policy is to retain logs and artifacts for 90 days.</span>
    - name: Darwin Upload Lisp Build
      uses: actions/upload-artifact@v2
      with:
        name: pi-build-macOS
        path: |
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/ProjectIsidore
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/assets/
          $<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/COPYING.txt

  build_executable_windows:
    name: MSWindows Build
    runs-on: <span class="org-rainbow-delimiters-depth-1">[</span>windows-latest<span class="org-rainbow-delimiters-depth-1">]</span>

    steps:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Microsoft Windows has evolved in parallel with UNIX systems to</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">have different pathnames and newline characters.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Note well the %HOMEPATH% variable is not set in [windows-latest] runner environments.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">See also https://github.com/actions/virtual-environments/issues/1301.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Also note conversion of UNIX style line endings (LF)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">to Windows style lines endings (CRLF) must be disabled when</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">checking out the git repository.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">SBCL does not support CRLF. For more information see</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">https://sourceforge.net/p/sbcl/mailman/message/27045870/</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">https://stackoverflow.com/questions/17926556/on-windows-cr-still-here-after-read-line-in-common-lisp</span>
    - name: Setup Windows Environment
      shell: pwsh
      run:
        git config --global core.autocrlf false;
        <span class="org-builtin">echo</span> <span class="org-string">"BUILDPACK_DIR=${{ github.workspace }}\bin\" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append;</span>
<span class="org-string">        echo "</span><span class="org-variable-name">CACHE_DIR</span>=$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> github.workspace <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>\buildcache<span class="org-string">\"</span> | Out-File -FilePath $<span class="org-variable-name">Env</span>:GITHUB_ENV -Encoding utf-8 -Append;
        <span class="org-builtin">echo</span> <span class="org-string">"BUILD_DIR=${{ github.workspace }}\" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append;</span>
<span class="org-string">        echo "</span><span class="org-variable-name">QL_DIST_VER</span>=<span class="org-highlight-numbers-number">2021-12-30</span><span class="org-string">" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append;</span>
<span class="org-string">        echo "</span><span class="org-variable-name">CL_IMPL_VER</span>=<span class="org-highlight-numbers-number">2.2.0</span><span class="org-string">" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append;</span>

<span class="org-string">    # Check out your repository under $GITHUB_WORKSPACE, so your job can access it</span>
<span class="org-string">    # $GITHUB_WORKSPACE may vary under $MATRIX.OS</span>
<span class="org-string">    - name: Clone Project Isidore Repository</span>
<span class="org-string">      uses: actions/checkout@v2</span>

<span class="org-string">    # No convenient apt or brew package managers.</span>
<span class="org-string">    # Download and unzip binary from official SBCL repository.</span>
<span class="org-string">    - name: Install SBCL &amp; Quicklisp</span>
<span class="org-string">      shell: pwsh</span>
<span class="org-string">      run:</span>
<span class="org-string">        mkdir "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CACHE_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span><span class="org-string">";</span>
<span class="org-string">        Invoke-WebRequest -UserAgent "</span>Wget<span class="org-string">" -uri "</span> https://sourceforge.net/projects/sbcl/files/sbcl/$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CL_IMPL_VER <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>/sbcl-$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CL_IMPL_VER <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>-x86-64-windows-binary.msi/download <span class="org-string">" -Method "</span>GET<span class="org-string">" -OutFile "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CACHE_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>sbcl-bin.msi<span class="org-string">";</span>
<span class="org-string">        mkdir "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.CACHE_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>sbcl<span class="org-string">\"</span>;
        Start-Process msiexec.exe -Wait -ArgumentList <span class="org-string">'/I ${{ Env.CACHE_DIR }}sbcl-bin.msi INSTALLDIR="${{ Env.CACHE_DIR }}sbcl\" /quiet'</span>;
        mkdir <span class="org-string">"${{ Env.BUILDPACK_DIR }}lib\";</span>
<span class="org-string">        Invoke-WebRequest -uri "</span>https://beta.quicklisp.org/quicklisp.lisp<span class="org-string">" -Method "</span>GET<span class="org-string">" -OutFile "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.BUILDPACK_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>lib\quicklisp.lisp<span class="org-string">";</span>

<span class="org-string">    # If Packages.lisp changes, the cache will be invalidated.</span>
<span class="org-string">    # Github policy also invalidates caches not accessed in 7 days.</span>
<span class="org-string">    - name: Cache Quicklisp Libraries</span>
<span class="org-string">      uses: actions/cache@v2</span>
<span class="org-string">      with:</span>
<span class="org-string">        path: ${{ Env.CACHE_DIR }}</span>
<span class="org-string">        key: ${{ runner.os }}-build-${{ hashFiles('**/packages.lisp') }}</span>

<span class="org-string">    - name: Build Project Isidore</span>
<span class="org-string">      shell: pwsh</span>
<span class="org-string">      run:</span>
<span class="org-string">        ${{ Env.CACHE_DIR }}sbcl\sbcl.exe --dynamic-space-size 2000 --load "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.BUILDPACK_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>make.lisp<span class="org-string">"</span>

<span class="org-string">    # Powershell command is seperate as it needs to be exectued sequentially.</span>
<span class="org-string">    - name: Move Project Isidore Executable</span>
<span class="org-string">      shell: pwsh</span>
<span class="org-string">      run: Move-Item -Path "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.BUILD_DIR <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>src\ProjectIsidore.exe<span class="org-string">" -Destination "</span>$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-rainbow-delimiters-depth-2">{</span> Env.BUILD_DIR<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">}</span>ProjectIsidore.exe<span class="org-string">"</span>

<span class="org-string">    - name: MSWindows Upload Lisp Build</span>
<span class="org-string">      uses: actions/upload-artifact@v2</span>
<span class="org-string">      with:</span>
<span class="org-string">        name: pi-build-Windows</span>
<span class="org-string">        path: |</span>
<span class="org-string">          # </span><span class="org-string"><span class="custom-1">NOTE</span></span><span class="org-string"> THE .EXE REQUIRED FOR WINDOWS BUILDS</span>
<span class="org-string">          ${{ github.workspace }}/ProjectIsidore.exe</span>
<span class="org-string">          ${{ github.workspace }}/assets/</span>
<span class="org-string">          ${{ github.workspace }}/COPYING.txt</span>

<span class="org-string">  create_release:</span>
<span class="org-string">    name: Create Github Release</span>
<span class="org-string">    # Only run create_release if the tag starts with 'v'</span>
<span class="org-string">    if: ${{ startsWith(github.ref, 'refs/tags/v') }}</span>
<span class="org-string">    runs-on: [ubuntu-latest]</span>
<span class="org-string">    # Following jobs must succeed</span>
<span class="org-string">    needs: [build_executable_linux, build_executable_macOS, build_executable_windows]</span>

<span class="org-string">    steps:</span>
<span class="org-string">    # Check out your repository under $GITHUB_WORKSPACE, so your job can access it</span>
<span class="org-string">    # $GITHUB_WORKSPACE may vary under $MATRIX.OS</span>
<span class="org-string">    - name: Clone Project Isidore Repository</span>
<span class="org-string">      uses: actions/checkout@v2</span>
<span class="org-string">      with:</span>
<span class="org-string">        fetch-depth: '0'</span>

<span class="org-string">    # Extract 'v*.*.*' from git refs</span>
<span class="org-string">    - name: Set Environment Variables</span>
<span class="org-string">      run: echo "</span><span class="org-variable-name">RELEASE_VERSION</span>=$<span class="org-rainbow-delimiters-depth-1">{</span><span class="org-variable-name">GITHUB_REF</span>#refs/*/<span class="org-rainbow-delimiters-depth-1">}</span><span class="org-string">" &gt;&gt; $GITHUB_ENV</span>

<span class="org-string">    - name: Download Artifacts</span>
<span class="org-string">    # Downloads all executable artifacts in it's own folder to the current working directory</span>
<span class="org-string">      uses: actions/download-artifact@v2</span>

<span class="org-string">    # </span><span class="org-string"><span class="custom">TODO</span></span><span class="org-string">: Convert Declt generated .texi to .pdf and .info and upload as well?</span>
<span class="org-string">    - name: Format Release Notes</span>
<span class="org-string">      shell: bash</span>
<span class="org-string">      run: |</span>
<span class="org-string">        echo "</span>Project Changelog Conventions:<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Feature - A new feature<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Fix - A bug fix<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Performance - A code change that improves performance<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Docs - Documentation only changes<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Tests - Adding missing tests or correcting existing tests<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Build - Changes that affect the build system or external dependencies<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>CI - Changes to our Continous Integration/Continous Delivery configuration files and scripts<span class="org-string">" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "</span>Chore - Other changes that don<span class="org-string">'t modify src or test files" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "Style - Changes that do not affect the meaning of the code (white-space formatting)" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        echo "Revert - Reverts a previous commit" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        declare -a arr=("Feat" "Fix" "Perf" "Docs" "Tests" "Build" "CI" "Refactor" "Chore" "Style" "Revert")</span>
<span class="org-string">        for i in "${arr[@]}"</span>
<span class="org-string">        do</span>
<span class="org-string">            export commitdata=$(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> log $(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> describe --abbrev=0 --tags $(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> rev-list --tags --skip=1 --max-count=1))..$(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> describe --tags --abbrev=0) --pretty=format:"[%h] (%as) %s" -i -E --grep="^(${i}\:)*${i}\:")</span>
<span class="org-string">            # if $commitdata is empty</span>
<span class="org-string">            if [ -z "$commitdata" ]</span>
<span class="org-string">            then</span>
<span class="org-string">                echo "Commit type ${i} is empty"</span>
<span class="org-string">            else</span>
<span class="org-string">                echo "* ${i}" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">                echo "" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">                git log $(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> describe --abbrev=0 --tags $(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> rev-list --tags --skip=1 --max-count=1))..$(</span><span class="org-sh-quoted-exec">git</span><span class="org-string"> describe --tags --abbrev=0) --pretty=format:"[%h] (%as) %s" -i -E --grep="^(${i}\:)*${i}\:" &gt;&gt; ${{github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">                echo "" &gt;&gt; ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">            fi</span>
<span class="org-string">        done</span>

<span class="org-string">    - name: Stage for Release</span>
<span class="org-string">      run: |</span>
<span class="org-string">        pushd ${{ github.workspace }}/pi-build-Linux</span>
<span class="org-string">        zip -r project-isidore-Linux-x86-64-${{ env.RELEASE_VERSION }}.zip ./*</span>
<span class="org-string">        popd</span>
<span class="org-string">        pushd ${{ github.workspace }}/pi-build-macOS</span>
<span class="org-string">        zip -r project-isidore-macOS-x86-64-${{ env.RELEASE_VERSION }}.zip ./*</span>
<span class="org-string">        popd</span>
<span class="org-string">        pushd ${{ github.workspace }}/pi-build-Windows</span>
<span class="org-string">        # IMPORTANT Bash RELEASE_VERSION variable does not inherit properly when using msys2 during the '</span>build_exectuable_windows<span class="org-string">' job. Go figure.</span>
<span class="org-string">        zip -r project-isidore-Windows-x86-64-${{ env.RELEASE_VERSION }}.zip ./*</span>
<span class="org-string">        popd</span>

<span class="org-string">    - name: Release Project Isidore</span>
<span class="org-string">      uses: softprops/action-gh-release@v1</span>
<span class="org-string">      with:</span>
<span class="org-string">        discussion_category_name: "Announcements"</span>
<span class="org-string">        name: "Project Isidore | New in ${{ env.RELEASE_VERSION }}"</span>
<span class="org-string">        body_path: ${{ github.workspace }}/CHANGELOG.txt</span>
<span class="org-string">        files: |</span>
<span class="org-string">          ${{ github.workspace }}/pi-build-Linux/project-isidore-Linux-x86-64-${{ env.RELEASE_VERSION }}.zip</span>
<span class="org-string">          ${{ github.workspace }}/pi-build-macOS/project-isidore-macOS-x86-64-${{ env.RELEASE_VERSION }}.zip</span>
<span class="org-string">          ${{ github.workspace }}/pi-build-Windows/project-isidore-Windows-x86-64-${{ env.RELEASE_VERSION }}.zip</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-Testing" class="outline-3">
<h3 id="Testing"><span class="section-number-3">7.2.</span> Testing</h3>
<div class="outline-text-3" id="text-Testing">
<p>
<a href="https://www.hanshenwang.com/code-coverage-report/cover-index.html">Project Isidore code coverage report.</a> Tests are run prior to building, see
Make.Lisp.
</p>

<p>
There does exist a detailed evaluation of the many existing Common Lisp testing
frameworks, the most recent iteration by <a href="https://sabracrolleton.github.io/testing-framework">Sabracrolleton</a>. From this we select <code>parachute</code>
as our testing framework of choice.
</p>

<p>
Project Isidore code aims to be portable Common Lisp within reason. <a href="https://portability.cl/">Common Lisp
Portability Library Status</a>
</p>
</div>
<div id="outline-container-Notes-on-Drakma" class="outline-4">
<h4 id="Notes-on-Drakma"><span class="section-number-4">7.2.1.</span> Notes on Drakma</h4>
<div class="outline-text-4" id="text-Notes-on-Drakma">
<p>
From: <a href="https://courses.cs.northwestern.edu/325/admin/json-client.php">https://courses.cs.northwestern.edu/325/admin/json-client.php</a>
</p>

<p>
Install Drakma
</p>

<p>
This should be easy.
</p>

<p>
(ql:quickload "drakma")
</p>

<p>
Using Drakma
</p>

<p>
Get data with URLs in Drakma is simple:
</p>

<p>
(drakma:http-request url)
</p>

<p>
url needs to be a string containing a complete URL. Drakma will send a request
for that URL to the server indicated, just as a browser or other user client
would.
</p>

<p>
drakma:http-request returns seven values, as Lisp multiple values. If you need
to save or use values other than the first, use multiple-value-bind or a similar
form. The values returned, in order, are
</p>

<p>
the body of the reply, either a string, when getting HTML or plain text, a
binary array for images, audio, and JSON, or a file stream, if requested
using a keyword parameter the HTTP status code an alist of the headers sent
by the server the URI the reply comes from, which might be different than
the request when redirects occur the stream the reply was read from a
boolean indicating whether the stream should be closed the server's status
text, e.g., "OK"
</p>
</div>
</div>

<div id="outline-container-Debugging" class="outline-4">
<h4 id="Debugging"><span class="section-number-4">7.2.2.</span> Debugging</h4>
<div class="outline-text-4" id="text-Debugging">
<p>
<a href="https://gist.github.com/nikodemus/659495/5461ac5181010bcd3118fa2cd03bc60aaf74d00a#file-sbcl-debugging-notes-txt">From a former maintainer of SBCL, Nikodemus Siivola.</a> The tracing and stickers
functionality in the SLY IDE is also very useful.
</p>

<blockquote>
<ol class="org-ol">
<li>Test case reduction is an essential skill, no matter the language or the
environment. It is the art of reducing the code that provokes the issue
(wrong result, an error, whatever) down to manageable size &#x2013; including the
full call path involved, and environmental issues like Slime vs no Slime, or
current directory. The smaller the better in general, but it is a balancing
act: if you can identify the issue using other methods in five minutes, it
doesn't make sense to spend an hour or two boiling down the test case. &#x2026;but
when other methods are not producing results, and time is dragging on then
you should consider this.</li>

<li>Defensive programming. Not just coding to protect against errors, but coding
so that your code is easy to debug. Avoid IGNORE-ERRORS and generally
swallowing errors silently. Sometimes it is the right thing to do, but the
more you do it, the harder <b>BREAK-ON-SIGNALS</b> becomes to use when you need
it. Avoid SAFETY 0 like the plague &#x2013; it can hide a multitude of sins. Avoid
DEBUG 0 &#x2013; it doesn't pay. Write PRINT-OBJECT methods for your objects, give
your objects names to use when printing. Check that slots are bound before
you use them in your PRINT-OBJECT methods. NEVER use INTERRUPT-THREAD or
WITH-TIMEOUT unless you really know what you are doing and exactly why I'm
telling you not to use them.</li>

<li>Stop to think. Read the error messages, if any, carefully. Sometimes they're
no help at all, but sometimes there are nuggets of information in them that a
casual glance will miss.</li>

<li>Know your environment. (This is what the question was really about, I
know&#x2026;)</li>
</ol>

<p>
3.0. M-. is gold. Plain v on a backtrace frame in Slime may also take you places
if your code has a sufficiently high debug setting, but M-. should work pretty
much always.
</p>

<p>
3.1. The Slime Inspector is one of my primary debugging tools &#x2013; but that is
probably affected by the kind of code I work on, so it might not be the same for
everyone. Still, you should familiarize yourself with it &#x2013; and use the fancy
one. :)
</p>

<p>
3.2. While SBCL backtraces aren't at the moment the pretties ones in the world,
try to make sense out of them. Just do (error "foo") in the REPL, and figure out
what is going on. Experiment with both the plain SBCL debugger and the fancy
Slime Debugger before you need to use them for real. They'll feel a lot less
hostile that way. I'll write advice on interpreting the backtraces at another
time.
</p>

<p>
3.3. Learn about <b>BREAK-ON-SIGNALS</b> and TRACE. Also note the SBCL extensions to TRACE.
</p>

<p>
3.4. The stepper isn't really a debugging tool, IMO &#x2013; it is a tool for
understanding control flow, which sometimes helps in debugging &#x2013; but if you
compile your code with DEBUG 3, then (STEP (FOO)) can take you to places.
</p>

<p>
3.5. Learn about M-RET (macroexpand) in Slime. Discover what happens if you do
(SETF <b>PRINT-GENSYM</b> NIL) first, and understand the potential danger there &#x2013;
but also the utility of being easily able to copy-paste the expansion into your
test case when you're trying to reduce it. (Replacing expansions of macros in
the COMMON-LISP package is typically pointless, but replacing those from user
packages can be golden.)
</p>

<p>
3.6. If all else fails, do (sb-ext:restrict-compiler-policy 'safety 3) and
(sb-ext:restrict-compiler-policy 'debug 3) and recompile your code. Debugging
should be easier now. If the error goes away, either (a) you had a type-error or
similar in SAFETY 0 code that was breaking stuff but is now swallowed by an
IGNORE-ERRORS or a HANDLER-CASE or (b) you may have found on SBCL bug: compiler
policy should not generally speaking change codes behaviour &#x2013; though there are
some ANSI mandated things for SAFETY 3, and high DEBUG can inhibit tail-call
optimizations which, as Schemers know, can matter.
</p>

<p>
3.7. DISASSEMBLE isn't normally a debugging tool, but sometimes it can help too.
Depends on what the issue is.
</p>

<ol class="org-ol">
<li>Extensions to printf() debugging. Sometimes this is just the easiest thing.
No shame in there.</li>
</ol>

<p>
4.1. Special variables are nice.
</p>

<p>
(LET ((<b>DEBUG</b> :MAGIC)) &#x2026;) and elsewhere (WHEN (EQ :MAGIC <b>DEBUG</b>) (PRINT
(LIST :FOO FOO)))
</p>

<p>
Because I'm lazy, I tend to use * as the magic variable, so I can also trivially
set it in the REPL. This allows you to get the debugging output for stuff you
are interested in only when certain conditions are true. Or you can use it to
tell which code path the call is coming from, etc.
</p>

<p>
4.2. Don't be afraid to add (break "foo=~S" foo) and similar calls to the code
you're debugging.
</p>

<p>
4.3. SB-DEBUG:BACKTRACE can sometimes be of use.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-Logging" class="outline-4">
<h4 id="Logging"><span class="section-number-4">7.2.3.</span> Logging</h4>
<div class="outline-text-4" id="text-Logging">
<p>
Heroku will store your application logs for you. Logging is a step above print
debugging and can be thought of as "live" documentation. If you don't have the
interactivity of the LISP REPL for diagnosis as physician, then you must debug
through diagnosis as mortician. Good logs are as useful as detailed blood
stains.
</p>
</div>
</div>
<div id="outline-container-Generate-Code-Coverage-Report" class="outline-4">
<h4 id="Generate-Code-Coverage-Report"><span class="section-number-4">7.2.4.</span> Generate Code Coverage Report</h4>
<div class="outline-text-4" id="text-Generate-Code-Coverage-Report">
<div class="org-src-container">
<pre class="src src-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">Generate Code Coverage Report</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">SBCL specific contrib module.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> <span class="org-constant">:sb-cover</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Compiler knob: Turn on generation instrumentation</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">declaim</span> <span class="org-rainbow-delimiters-depth-2">(</span>optimize sb-cover:store-coverage-data<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Load while ensuring that it's recompiled with the new optimization</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">policy.</span>
<span class="org-rainbow-delimiters-depth-1">(</span>asdf:load-system <span class="org-builtin">:project-isidore</span> <span class="org-builtin">:force</span> t<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>asdf:test-system <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">HTML report output location</span>
<span class="org-rainbow-delimiters-depth-1">(</span>sb-cover:report <span class="org-string">"../assets/code-coverage-report/"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">declaim</span> <span class="org-rainbow-delimiters-depth-2">(</span>optimize <span class="org-rainbow-delimiters-depth-3">(</span>sb-cover:store-coverage-data <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-unmatched">))</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-User-Manual" class="outline-2">
<h2 id="User-Manual"><span class="section-number-2">8.</span> User Manual</h2>
<div class="outline-text-2" id="text-User-Manual">
</div>
<div id="outline-container-How-do-I-find-past-versions-of-a-blog-article" class="outline-3">
<h3 id="How-do-I-find-past-versions-of-a-blog-article"><span class="section-number-3">8.1.</span> How do I find past versions of a blog article?</h3>
<div class="outline-text-3" id="text-How-do-I-find-past-versions-of-a-blog-article">
<p>
To view the entire revision history of an article, find and click the article
title on <a href="https://github.com/HanshenWang/project-isidore/tree/master/assets/blog">the repository's blog subfolder.</a> Then click on the <code>History</code> button
to view specific, atomic changes. <a href="https://github.com/HanshenWang/project-isidore/releases/">Project release notes</a> are available for a
general overview and inputting the article URL into <a href="https://archive.org/web/">the Internet Wayback
Machine</a> is also an option.
</p>
</div>
</div>

<div id="outline-container-How-do-I-unsubscribe-from-the-mailing-list" class="outline-3">
<h3 id="How-do-I-unsubscribe-from-the-mailing-list"><span class="section-number-3">8.2.</span> How do I unsubscribe from the mailing list?</h3>
<div class="outline-text-3" id="text-How-do-I-unsubscribe-from-the-mailing-list">
<p>
To remove an email address from the mailing list, fill out and submit the form
on the <a href="https://www.hanshenwang.com/unsubscribe">unsubscribe page.</a> To resubscribe, visit <a href="https://www.hanshenwang.com/subscribe">https://www.hanshenwang.com/subscribe.</a>
</p>
</div>
</div>

<div id="outline-container-Can-I-visit-this-website-offline" class="outline-3">
<h3 id="Can-I-visit-this-website-offline"><span class="section-number-3">8.3.</span> Can I visit this website offline?</h3>
<div class="outline-text-3" id="text-Can-I-visit-this-website-offline">
<p>
To access the website offline, download the appropriate executable
from the project release page. <a href="https://github.com/HanshenWang/project-isidore/releases">Releases · HanshenWang/project-isidore · GitHub</a>.
</p>

<p>
Find the appropriate exectuable matching both your computer's processor
architecture and the operating system. Currently only the x86-64 architecture is
supported on Linux, MacOS and Windows operating systems.
</p>

<p>
Project Isidore does not offer signed binaries for MacOS, therefore you will
have to manually execute the unsigned binaries. Please see
<a href="https://lapcatsoftware.com/articles/unsigned.html">https://lapcatsoftware.com/articles/unsigned.html</a> for more details.
</p>

<p>
When running the Windows binary you may run into an error similar to,
</p>

<div class="org-src-container">
<pre class="src src-text">("libcrypto-1_1-x64.dll" "libeay32.dll") [Condition of type CFFI:LOAD-FOREIGN-LIBRARY-ERROR]
</pre>
</div>

<p>
Project Isidore uses the <a href="https://common-lisp.net/project/cl-plus-ssl/">cl+ssl</a> library which in turn requires OpenSSL as a
dependency if the web server is to send HTTPS requests. Hit <code>0</code> to continue twice
and the application will proceed as normal. Firewall network exceptions need not
be granted if the application is to be used locally.
</p>

<p>
An audit of the source code can be done at any time. Please see the <a href="#Introduction">source
repository</a> as well as the <a href="#Libraries-System-dependencies">third party dependencies.</a>
</p>

<p>
Be advised that the program consumes around 50MB of RAM when used by a single
user locally. Please understand the executable is provided AS IS, WITHOUT
WARRANTY. See the provided COPYING.txt included in the download.
</p>
</div>
</div>

<div id="outline-container-I-can't-find-what-I'm-looking-for-How-is-the-documentation-organized" class="outline-3">
<h3 id="I-can't-find-what-I'm-looking-for-How-is-the-documentation-organized"><span class="section-number-3">8.4.</span> I can't find what I'm looking for. How is the documentation organized?</h3>
<div class="outline-text-3" id="text-I-can't-find-what-I'm-looking-for-How-is-the-documentation-organized">
<p>
The documentation is organized according to the best practices outlined here:
<a href="https://documentation.divio.com/">The documentation system — divio.</a>
</p>

<p>
The closest thing to a tutorial as understood by the divio documentation system
ought to be the development quickstart <a href="https://github.com/HanshenWang/project-isidore/blob/master/README.org">(present in the README.org)</a> or embedded
as close as possible to the end-user interface. How-to guides are meant to be
placed here in the user manual. The Reference is auto-generated with the help of
<a href="#Generate-Reference-Manual">the Declt system</a>. The Explanation is this Design Notebook blog article and git
commit messages.
</p>
</div>
</div>
</div>

<div id="outline-container-Reference-Manual" class="outline-2">
<h2 id="Reference-Manual"><span class="section-number-2">9.</span> Reference Manual</h2>
<div class="outline-text-2" id="text-Reference-Manual">
<p>
Reference manuals are technical descriptions of Project Isidore's internal
artifact architecture and how to operate it. For end users, please see the <a href="#User-Manual">User
Manual</a>.
</p>

<p>
<a href="https://www.hanshenwang.com/reference/manual.html">The Project Isidore Reference Manual</a> is complete with cross-references to ASDF
component dependencies, parents and children, classes' direct methods, super and
subclasses, slot readers and writers, setf expanders access and update functions
etc. The reference manual also includes exhaustive and multiple-entry indexes
for every documented item.
</p>

<ul class="org-ul">
<li>System components (modules and files)</li>
<li>Packages</li>
<li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/11_aaba.htm">Exported and internal definitions of</a>
<ul class="org-ul">
<li>Constants</li>
<li>Special variables</li>
<li>Symbol macros</li>
<li>Macros</li>
<li>Setf expanders</li>
<li>Compiler macros</li>
<li>Functions</li>
<li>Generic functions</li>
<li>Generic methods,</li>
<li>Method combinations,</li>
<li>Conditions</li>
<li>Structures</li>
<li>Classes</li>
<li>Types</li>
</ul></li>
</ul>

<p>
With all that being said, when the boundary between user and developer is
crossed, it makes much more sense to clone the source code and explore it in
your LISP IDE. Auto generated manuals may be slightly more useful in LISP than
other languages, thanks to the excellent introspection capabilities of SBCL and
ASDF, but still are largely only useful for index generation.
</p>
</div>
<div id="outline-container-Generate-Reference-Manual" class="outline-3">
<h3 id="Generate-Reference-Manual"><span class="section-number-3">9.1.</span> Generate Reference Manual</h3>
<div class="outline-text-3" id="text-Generate-Reference-Manual">
<p>
The <a href="https://github.com/didierverna/declt">Declt Common Lisp library</a> is used generate the reference manual in <code>.texi</code>
texinfo format. <a href="https://www.gnu.org/software/texinfo/manual/texinfo/texinfo.html">GNU Texinfo</a> is able to convert a single <code>.texi</code> source file into
online HTML format, PDF documentation as well as others. On a high level, Declt
uses ASDF and SBCL contrib <code>sb-introspect</code> to query and extract documentation
strings, lambda lists, slot type, allocation and initialization arguments, and
definition source files. It requires no special architecture choices in a
system, other than to conform to ASDF conventions. Beyond that, writing clear
docstrings where the opportunity arises will yield great results.
</p>

<p>
<code>generate-doc.lisp</code> script is run by a git pre-commit hook. Upon every commit,
it will regenerate the reference manual and include changes into the commit.
<code>pre-commit</code> is originally located at
<code>/project-isidore/.git/hooks/pre-commit.sample</code>.
</p>

<p>
Is this workflow overkill for the size of the codebase currently? Probably. It
is nice to have an auto-generated manual though.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgc94f60e"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">An example hook script to verify what is about to be committed.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Called by "git commit" with no arguments.  The hook should</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">exit with non-zero status after issuing an appropriate message if</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">it wants to stop the commit.</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">To enable this hook, rename this file to "pre-commit".</span>

<span class="org-keyword">if</span> git rev-parse --verify HEAD &gt;/dev/null <span class="org-highlight-numbers-number">2</span>&gt;&amp;<span class="org-highlight-numbers-number">1</span>
<span class="org-keyword">then</span>
    <span class="org-variable-name">against</span>=HEAD
<span class="org-keyword">else</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Initial commit: diff against an empty tree object</span>
    <span class="org-variable-name">against</span>=$<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-sh-quoted-exec">git</span> hash-object -t tree /dev/null<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Redirect output to stderr.</span>
<span class="org-keyword">exec</span> <span class="org-highlight-numbers-number">1</span>&gt;&amp;<span class="org-highlight-numbers-number">2</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Generate updated manual. SBCL must be installed. See documentation for</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">environment setup</span>
sbcl --script doc/generate-doc.lisp
<span class="org-comment-delimiter"># </span><span class="org-comment">Add updated manual.html to commit</span>
git add assets/reference/manual.html
</pre>
</div>

<div class="org-src-container">
<pre class="src src-lisp" id="org2a4135d"><span class="org-comment-delimiter">;;;; </span><span class="org-comment">generate-doc.lisp</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">See subheading 'Generate Reference Manual' at</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">https://www.hanshenwang.com/blog/project-isidore-doc.html/</span>

<span class="org-rainbow-delimiters-depth-1">(</span>load <span class="org-string">"~/quicklisp/setup.lisp"</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; Quicklisp is installed in default location</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:project-isidore</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment">; If you need to download dependencies</span>
<span class="org-rainbow-delimiters-depth-1">(</span>ql:quickload <span class="org-builtin">:net.didierverna.declt</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Generate 'project-isidore.texi' in TEXI-DIRECTORY</span>
<span class="org-rainbow-delimiters-depth-1">(</span>net.didierverna.declt:declt <span class="org-builtin">:project-isidore</span>
                             <span class="org-builtin">:texi-name</span> <span class="org-string">"manual"</span>
                             <span class="org-builtin">:texi-directory</span>
                             <span class="org-rainbow-delimiters-depth-2">(</span>asdf:system-relative-pathname
                              <span class="org-builtin">:project-isidore</span> <span class="org-string">"../assets/reference/"</span><span class="org-rainbow-delimiters-depth-2">)</span>
                             <span class="org-builtin">:library-name</span> <span class="org-string">"Project Isidore"</span>
                             <span class="org-comment-delimiter">;; </span><span class="org-comment">links are machine specific</span>
                             <span class="org-builtin">:hyperlinks</span> nil
                             <span class="org-comment-delimiter">;; </span><span class="org-comment">:long will print generation time. This will be</span>
                             <span class="org-comment-delimiter">;; </span><span class="org-comment">picked up by git. Otherwise I would pick :long</span>
                             <span class="org-builtin">:declt-notice</span> <span class="org-builtin">:short</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">https://lispcookbook.github.io/cl-cookbook/os.html#input-and-output-from-subprocess</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defparameter</span> <span class="org-variable-name">*shell*</span> <span class="org-rainbow-delimiters-depth-2">(</span>uiop:launch-program <span class="org-string">"bash"</span> <span class="org-builtin">:input</span> <span class="org-builtin">:stream</span>
                                                  <span class="org-builtin">:output</span> <span class="org-builtin">:stream</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Change to proper directory</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defparameter</span> <span class="org-variable-name">*manual-path*</span> <span class="org-rainbow-delimiters-depth-2">(</span>concatenate
                             'string <span class="org-string">"cd "</span>
                             <span class="org-rainbow-delimiters-depth-3">(</span>namestring
                              <span class="org-rainbow-delimiters-depth-4">(</span>asdf:system-relative-pathname
                               <span class="org-builtin">:project-isidore</span> <span class="org-string">"../assets/reference/"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>write-line *manual-path* <span class="org-rainbow-delimiters-depth-2">(</span>uiop:process-info-input *shell*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Convert .texi to .html</span>
<span class="org-rainbow-delimiters-depth-1">(</span>write-line
   <span class="org-comment-delimiter">;; </span><span class="org-comment">For makeinfo flags, see</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">https://www.gnu.org/software/texinfo/manual/texinfo/texinfo.html#HTML-CSS</span>
 <span class="org-string">"makeinfo --html 'manual.texi' --no-split --css-include='../global.css'"</span>
 <span class="org-rainbow-delimiters-depth-2">(</span>uiop:process-info-input *shell*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>force-output <span class="org-rainbow-delimiters-depth-2">(</span>uiop:process-info-input *shell*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-Project-History-Credits" class="outline-2">
<h2 id="Project-History-Credits"><span class="section-number-2">10.</span> Project History &amp; Credits</h2>
<div class="outline-text-2" id="text-Project-History-Credits">
<p>
For previous project iterations and experience, see project-isidore-java repository
on GitHub using Java Spring, and project-isidore-javascript currently on GitHub
using NextJS. <a href="0401bc27-686c-4276-a46d-6d95f05dce56">See also MEAN stack notes.</a>
</p>

<p>
Credit must be given where credit is due.
</p>

<p>
Thank you,
</p>
<ul class="org-ul">
<li>Wonderful friends and family</li>
<li>(Spac)Emacs Community</li>
<li>Common Lisp Community <a href="#Libraries-System-dependencies">(see library authors)</a></li>
<li>Github, Heroku, Cloudflare, Sourceforge</li>
</ul>
</div>
</div>
<div id="bibliography">
<h2>References</h2>

<table>

<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="chaconProGit2014">1</a>]
</td>
<td class="bibtexitem">
Scott Chacon.
 <em>Pro Git</em>.
 The Expert's Voice in Software Development. Apress, New York, NY,
  second edition edition, 2014.

</td>
</tr>
</table>
</div>
</div>
<div id="postamble" class="status">
<script>
                              const headers = Array.from( document.querySelectorAll('h2, h3, h4, h5, h6') );

                              headers.forEach( header => {
                                header.insertAdjacentHTML('afterbegin',
                                 '<a href="#table-of-contents">&#8689;</a>'
                                );
                              });
                              </script>
                              <hr/>
                              <footer>
                                <div class="copyright-container">
                                  <div class="copyright">
                                    Comments? Corrections? <a
                                href="https://hanshenwang.com/contact">
                                Please do reach out.</a><a
                                href="https://hanshenwang.com/blog/rss.xml">
                                RSS Feed. </a><a
                                href="https://hanshenwang.com/subscribe">
                                Mailing List. </a><br/>
                                    Copyright &copy; 2021 Hanshen Wang. Some Rights Reserved.<br/>
                                    Blog content is available under
                                    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                                      CC-BY-SA 4.0
                                    </a> unless otherwise noted.
                                  </div>
                                  <div class="cc-badge">
                                    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                                      <img alt="Creative Commons License"
                                           src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"
                                           height="31"
                                           width="88">
                                    </a>
                                  </div>
                                  <div class="rss-badge">
                                    <a rel="license" href="http://hanshenwang.com/blog/rss.xml">
                                      <img alt="Really Simple Syndication - RSS"
                                           src="https://upload.wikimedia.org/wikipedia/en/thumb/4/43/Feed-icon.svg/50px-Feed-icon.svg.png"
                                           height="50"
                                           width="50">
                                    </a>
                                  </div>
                                </div>

                                <div class="generated">
                                  Created with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.5.2) on <a href="https://www.gnu.org">GNU</a>/<a href="https://www.kernel.org/">Linux</a>
                                </div>
                              </footer>
</div>
</body>
</html>
