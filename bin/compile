#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# compile bash script
#
# Copyright (c) 2021 Hanshen Wang.
#
# Author: Hanshen Wang <Hanshen@HanshenWang.com>
# URL: https://github.com/HanshenWang/project-isidore
#
# This file is part of Project Isidore.
#
# Project Isidore is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Project Isidore is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Project Isidore.  If not, see <https://www.gnu.org/licenses/>.

BUILDPACK_VERSION="0.1.0"

function getenv() {
    ENV_NAME="$1"
    DEFAULT="$2"
    ENV_VAL="$DEFAULT"

    if [ -f "$ENV_DIR/$ENV_NAME" ]; then
        ENV_VAL=$(cat "$ENV_DIR/$ENV_NAME")
    fi

    echo "$ENV_VAL"
}

function log {
  echo "-----> $1"
}

function info {
  echo "        $1"
}


BUILDPACK_DIR=$(cd $(dirname "$0"); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
CL_IMPL="$(getenv CL_IMPL 'ccl-bin')"

log "-----> Common Lisp buildpack $BUILDPACK_VERSION"
info "BUILD_DIR: $BUILD_DIR"
info "CACHE_DIR: $CACHE_DIR"
info "CL_IMPL: $CL_IMPL"

if [ "$RESET_CACHE" ]; then
    log "Flushing Cache..."
    rm -rf "${CACHEDIR:?}/"*
fi

git clone -b release https://github.com/roswell/roswell.git
pushd roswell || exit
sh bootstrap
./configure --prefix ~/.local/
make
make install
export PATH=$PATH:~/.local/bin/
ros setup
ros install "$CL_IMPL"
ros use "$CL_IMPL"
popd || exit

log "compiling application"
export BUILDPACK_DIR
export CACHE_DIR
export BUILD_DIR

ros run --asdf --load "$BUILDPACK_DIR/bin/compile.lisp" --quit
log "compilation complete"

chmod a+x "$BUILD_DIR/lispapp" # grant permissions for application
